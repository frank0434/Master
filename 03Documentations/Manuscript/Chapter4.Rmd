---
title: "Chapter4"
author: "jian (AKA Frank) liu"
date: "17/01/2021"
output:
  html_document:
    df_print: paged
  word_document:
    reference_docx: dissertationTemplate.docx
always_allow_html: yes
---

# Experiment details

a.  **2** years experiment.

b.  **2** sites

    a.  Lincoln Uni
    b.  Ashely Dene

c.  **10** sowing date in both sites.

    a.  five sowing date in the first year
    b.  five sowing date in second year

| Year 1 (Seedling crop)  | Year 2 (Seedling & Regrowth)        |
|-------------------------|-------------------------------------|
| SD1, SD2, SD3, SD4, SD5 | The first five sowing date Regrowth |
|                         | SD6, SD7, SD8, SD9, SD10            |

*Note:* The setup helps to compare the seedling and regrowth in the same conditions in Year 2.

d.  **1** cultivar.

e.  **4** reps each site.

f.  **2** soil types

    a.  stone free - plant available water capaciy (PAWC) 360mm/2.3m
    b.  ~~stony - PAWC 240/2.3m~~ This type is for a grazing trial. probably not a good idea for a starting?
    c.  very stony 130mm/2.3m

g.  **22** layers of soil water measurements - 10 cm interval below top 20 cm

    a.  top 20 cm was measured by TDR.
    b.  remaining 21 layers was meastured by Neutron probe

h.  **1** follow treat in both sites - absolute soil evaporation

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 10, fig.height = 7, 
                      dpi = 300)
options(scipen = 999)
#Constants
outlier.colour = "#ff0000"
source(here::here("02Scripts/R/packages.R"))
source(here::here("02Scripts/R/functions.R"))
path_richard <- "C:/Users/cflfcl/Dropbox/Data/APSIM_Sim.xlsx"
id_vars <- c("Experiment", "SowingDate", "Clock.Today", "DAS")

data_sw <- read_Sims(path = path_richard)

value_vars <-  grep("SWmm\\.\\d.", colnames(data_sw), value = TRUE)
sw_mean_new <- colwise_meanSW(data_sw)

# Colour p
blues <- c("#0f5e9c",
           "#2389da",
           "#1ca3ec",
           "#5abcd8",
           "#74ccf4")
names(blues) <- blues 
ggplot(data.frame(x = blues, y = 1),aes(x, y, fill = x)) +
  geom_col() +
  scale_fill_manual(name = "", values = blues)+
  theme_void()
```

|      | AD        | I12       |
|:-----|:----------|:----------|
| SD1  | 21-Oct-10 | 4-Oct-10  |
| SD2  | 9-Nov-10  | 4-Nov-10  |
| SD3  | 8-Dec-10  | 2-Dec-10  |
| SD4  | 13-Jan-11 | 10-Jan-11 |
| SD5  | 3-Feb-11  | 7-Feb-11  |
| SD6  | 10-Oct-11 | 10-Oct-11 |
| SD7  | 7-Nov-11  | 7-Nov-11  |
| SD8  | 9-Dec-11  | 9-Dec-11  |
| SD9  | 10-Jan-12 | 10-Jan-12 |
| SD10 | 17-Feb-12 | 17-Feb-12 |

# DUL AND LL GRAPH

```{r}
DUL_LL_range <- doDUL_LL_range(SW = sw_mean_new,
                               startd = "2011-06-25")
# CF 0.95
DUL_LL_range[, ':=' (i.SW.DUL = i.SW.DUL * 0.95,
                     i.SW.LL = i.SW.LL * 0.95)]
```

```{r}
DUL_LL_range <- fix_SDorder(DUL_LL_range)
p_DUL_LL <- DUL_LL_range %>% 
  ggplot(aes(x = Depth))+
  geom_point(aes(y = SW.DUL , color = "DUL"))+
  geom_line(aes(y = SW.DUL, color = "DUL")) +
  geom_line(aes(y = SW.LL, color = "LL"))+
  geom_point(aes(y = SW.LL, color = "LL")) +
  scale_x_reverse() +
  coord_flip() +
  geom_ribbon(aes(ymin = SW.LL, ymax = SW.DUL), fill = "#1ca3ec") +
  facet_grid(  SowingDate ~ Experiment) +
  theme_water() +
  scale_color_manual(name = "", values = c("#0000FF", "#FF0000"))

p_DUL_LL
# ggsave("Figures/dul_ll.png",plot = p_DUL_LL, width = 7, height =10, dpi = 320)
# ggsave("Figures/dul_ll20110701.png",plot = p_DUL_LL, width = 7, height =10, dpi = 320)
```

# SOIL INITIAL WATER CONTENT GRAPH

```{r, fig.height=10}
sowingDates <-  read_Sims(path_richard, source =  "sowingDate")
# mimic the paper logic, force starting date to "2011-07-01"
# The nearest measurements were "2011-06-25" for sd1 to sd5
sowingDates[SowingDate%in% paste0("SD", 1:5), 
            Clock.Today := as.Date("2011-06-25")]
data_SW <- read_Sims(path = path_richard)
SW_mean_new <- colwise_meanSW(data_SW = data_SW, 
                              id.vars = id_vars, 
                              col.vars = value_vars)
sw_initials <- initialSWC(SW_mean_new, sowingDates, id_vars)

# # SW_INITALS FROM 1 JULY 2011
# sw_mean_new[Clock.Today >= "2011-06-25"
#             ][, range(Clock.Today), by = .(Experiment)]
# # Both sites had measurements on "2011-06-25"
# sw_initials <- initialSWC(SW_mean_new, sowingDates = "2011-06-25", id_vars)
# sw_initials
# sw_initials <- readRDS(here::here("_targets/objects/SW_initials"))
sw_initials <- fix_SDorder(sw_initials)

data_SW[SowingDate == "SD6"&Experiment == "Iversen12"] %>% 
  ggplot(aes(Clock.Today, SWmm.2.,group = Clock.Today)) + geom_boxplot()
```


```{r}
p_sw_initials <- sw_initials %>% 
  ggplot(aes(x = Depth))+
  geom_col(aes(y = SW, fill = "SWC"), position = "dodge", width = 1)+
  geom_line(data = DUL_LL_range, aes(y = SW.DUL, color = "DUL")) +
  geom_point(data = DUL_LL_range, aes(y = SW.DUL, color = "DUL"))+
  geom_line(data = DUL_LL_range,aes(y = SW.LL, color = "LL"))+
  geom_point(data = DUL_LL_range,aes(y = SW.LL, color = "LL")) +
  # geom_line(aes(y = SW))+
  scale_x_reverse() +
  scale_y_continuous(expand = c(0, 0), 
                     name = expression( "Volumetric water content"~ (mm^3 ~ mm^{-3}))) +
  coord_flip() +
  # geom_ribbon(aes(ymin = SW.LL, ymax = SW.DUL), fill = "grey80") +
  facet_grid(  SowingDate ~ Experiment) +
  theme_water() +
  theme(legend.margin = margin(0,0,0,0),
        legend.box.margin = margin(0,0,0,0)) +
  scale_fill_manual(name = "", values = "#74ccf4") +
  scale_colour_manual(name = "", values = c("#0000FF", "#FF0000"))
p_sw_initials
# ggsave("Figures/sw_initials.png",plot = p_sw_initials, width = 7, height =10, dpi = 320)
# ggsave("Figures/sw_initials_20110701.png",plot = p_sw_initials, width = 7, height =10, dpi = 320)
```

# Output an excel file for Fullvalidation apsimx manual configuration
```{r}
keySoilParams <- sw_initials[DUL_LL_range, on = .(Experiment, SowingDate, Depth)
                             ][, .(Experiment, SowingDate, Depth, 
                                   Clock.Today, DAS, SW,
                                   Clock.Today.DUL, DAS.DUL, i.SW.DUL,
                                   Clock.Today.LL, DAS.LL, i.SW.LL)]
# write.xlsx(keySoilParams, here::here("01Data/keySoilParams.xlsx"))
# write.xlsx(keySoilParams, here::here("01Data/keySoilParams20110701.xlsx"))
```

# Results wording 
what were the absolute values for profile initial swc?
what were the absolute values for profile initial DUL AND CLL?
```{r}

sw_dul_ll <-  sw_initials[DUL_LL_range, on = .(Experiment, SowingDate, Depth)]
PAW <- sw_dul_ll[, ':='(SWmm = ifelse(Depth == 1, SW * 200, SW * 100))
                 ][, PAW := SWmm - SW.LL
                   ][, .(Experiment, SowingDate, Depth, PAW)
                     ][, sum(PAW), by = .(Experiment, SowingDate)]
PAW[, range(V1), by = .(Experiment)]

PAW_wide <- PAW %>% 
  dcast.data.table(SowingDate ~ Experiment)

PAW_wide[, time:=Iversen12/AshleyDene] 
hist(PAW_wide$time)
```

```{r}
DUL_LL_range[, .(Experiment, i.SW.DUL)
             ][, range(i.SW.DUL), by = .(Experiment)]
DUL_LL_range[, .(Experiment, i.SW.LL)
             ][, range(i.SW.LL), by = .(Experiment)]
  
```

# PAWC IN A TABLE

```{r}
DUL_LL_range <- doDUL_LL_range(SW = sw_mean_new)
# DUL_LL_range <- fix_SDorder(DUL_LL_range)
PAWC <- DUL_LL_range[, ':='(SW.DUL = ifelse(Depth == 1, SW.DUL *200, SW.DUL*100),
                    SW.LL = ifelse(Depth == 1, SW.LL *200, SW.LL*100))
             ][, diff := SW.DUL - SW.LL
               ][,.(PAWC = sum(diff)), by = .(Experiment, SowingDate)
               ][, SDorder := as.integer(gsub("SD", "", SowingDate))
                 ][order(Experiment, SDorder)]

# PAWC$SowingDate <- factor(PAWC$SowingDate, levels = unique(PAWC$SowingDate)[c(1, 3:10, 2)])
# 
# PAWC$SowingDate <- as.factor(PAWC$SowingDate)
# PAWC$SowingDate <- forcats::fct_relevel(PAWC$SowingDate, paste0("SD", 1:10) )
# levels(PAWC$SowingDate)
# PAWC$SowingDate <-  factor(PAWC$SowingDate,
#                            levels = levels(PAWC$SowingDate)[c(1, 3:10, 2)])


PAWC %>%
  kbl(caption = "PAWC") %>%
  kable_classic(full_width = F) %>% 
  column_spec(4, width = 0)
PAWC[SowingDate %in% paste0("SD", 1:5)
     ][, .(mean = mean(PAWC),
           sd = sd(PAWC)), 
       by = .(Experiment)]
```

# KL IN A TABLE

```{r}


f <- "C:/Users/cflfcl/Dropbox/1. master_background_reading/soil/Sim et al 2016.pdf"
# extract_areas(f, 12)
tab <- extract_tables(f, pages = 12,   guess = FALSE, output = "data.frame")
class(tab)
dt_kl <- as.data.table(tab[[1]])

# dt_kl %>% class()
# dt_kl[7:13]
# setnames(dt_kl, names(dt_kl), dt_kl$Author.s.personal.copy[6])
dt_kl <- tidyr::separate(dt_kl[7:13], 1, sep = "\\s",into = paste0("V", 1:6), fill = "left") 
dt_kl <- dt_kl[is.na(V1), V1 := V3
      ][, V1:= gsub("â\200“", "-", V1)
        ][, (paste0("V", 2:6)) := lapply(.SD, as.numeric), by = .(V1)][]
dt_kl_layer <- rbindlist(list(dt_kl, dt_kl, dt_kl))[order(V1)]
dt_kl_layer$V1 <- 2:22

newnames <- c("Seedling Iversen12", "Seedling AshleyDene", 
              "Established Iversen12", "Established Stony", "Established AshleyDene")
setnames(dt_kl_layer, colnames(dt_kl_layer), c("Depth", newnames))
# Add an artifical layer with all kls = 0.06
dt_kl_layer <- rbindlist(list(dt_kl_layer, c(list(1L), rep(list(0.060), 5))))
dt_kl_layer <- dt_kl_layer[order(Depth)
                        ][, .(Depth,`Seedling AshleyDene`, `Established AshleyDene`,
                              `Seedling Iversen12`, `Established Iversen12`)]
# grahy
# dt_kl_AD <- dt_kl_AD %>% 
#   melt.data.table(., id.vars = "Depth") 
# dt_kl_AD[, value := as.numeric(value)] %>% 
#   ggplot(aes(x = Depth, y = value, color = variable ))+
#   geom_line()+
#   geom_point()+
#   scale_x_reverse() +
#   coord_flip() +
#   theme_water()

```

# BD IN A TABLE

Numbers extracted from [Graham et al 2019](https://www.sciencedirect.com/science/article/abs/pii/S037837741930887X?via%3Dihub)

```{r}
BDs <- as.data.table(read_excel(here::here("01Data/BulkDensity.xlsx")))

BDs <- BDs[, BDSE := ifelse(!is.na(Stderror),
                                   paste(BD_kg.m3, Stderror, sep = "\u00B1"), 
                            BD_kg.m3)
    ][,.(Depth, Experiment, BDSE)] %>% 
  dcast.data.table(Depth ~ Experiment)


```

# EFV IN A TABLE

only two values: once for AD and one for I12 unit `mm/d`

```{r}
EFV <- data.table( AshleyDene = "15.1±2.45", Iversen12 = "12.9±1.02")
EFV %>%
  melt.data.table(measure.vars = c("AshleyDene", "Iversen12"),
                  variable.name = "Site",
                  value.name = "EFV",
                  variable.factor = FALSE) %>% 
  kable()
# %>%
#   kbl(col.names = c("Site", "Root Front Velocity (SE) (mm/d)")) %>%
#   kable_classic()
```


# Combine and formatting

```{r}
BD_KL <- merge(BDs, dt_kl_layer, on = "Depth")
# BD_KL_EFV <- merge.data.table(BD_KL, EFV, on = "Depth",
#                               all.x = TRUE, suffixes = c("","EFV.mm.d-1"))
# BD_KL_EFV
BD_KL[, lapply(.SD, function(x) ifelse(is.na(x), "-", x))] %>%
  kbl() %>%
  kable_classic() %>%
  add_header_above(c(" " = 1, "Bulk Density (kg m-3)" = 2, "Water extraction rate (kl; mm d-1)" = 4))
```

# Evapotranspiration surface

This is for calibrate the model for Potential Ep since there is no crop growing on this area?

```{r ES, fig.height=7, fig.width=7, dpi=300}
# 
# vars <- colnames(ES[, Data:= NULL])[c(1:6)]
# ES_melted <- ES %>% 
#   melt(.,id.vars = vars, variable.factor = FALSE) %>% 
#   .[, variable := as.integer(gsub("SWC.0\\.", "", variable))]
# ES %>% 
#   ggplot(aes(Clock.Today, SWCES_0.0.2)) + 
#   geom_point() +
#   facet_grid(  Experiment ~ .) +
#   theme_water()

```

# MANAGEMENT MODULE
## sowing and cutting dates 

apsimx has a `mower` function in the factor to mimic harvest.   
the harvest date always one day after the actual harvest date.  
Probably because the `mower` just an simple remove all above ground function.  

```{r}
data_biomass <- read_Sims(path = path_richard,source = "biomass" )

dt = readxl::read_excel(path_richard, guess_max = 10300, sheet = 2,
               .name_repair ="universal",
               skip = 9 ) # fix the names 
dt = data.table::as.data.table(dt) 
data.table::setnames(dt, old = c("Site", "Date", "Sowing.Date"), 
                    new = c("Experiment", "Clock.Today", "SowingDate"))
dt[, ...119 := NULL]
col_type =  inspectdf::inspect_types(dt)
col_date = col_type$col_name[[3]]
dt[, (col_date) := lapply(.SD, function(x) as.Date(x,  tz = "Pacific/Auckland")),
  .SDcol = col_date]


manage <- dt[Seed == "CS" & !is.na(Total.FW..g.),.(Experiment, Clock.Today, Season, SowingDate, Seed, Harvest.No.,Rotation.No.)]
manage <- unique(manage)
```
**Harvest.No** is for drawing the growth curve.  
**Rotation.No** is for the cutting dates. 
Need to extract the last date of a rotation.no.   

```{r}
cutDates <- manage[, ':='(SDorder = as.integer(gsub("SD", "", SowingDate)),
              Harvest.No. = as.integer(Harvest.No.))
       ][!is.na(Harvest.No.) & Harvest.No. != 0,
         .SD[.N], by = .(Experiment, SowingDate, Rotation.No., Season)
         ][,.(Experiment, SowingDate, Season, Clock.Today,SDorder, Rotation.No.)]
Grazed <- cutDates[, .SD[.N],
         by = .(Experiment, SowingDate, Season, SDorder)
         ][,DefoliationMethod := "Grazed" 
           ][]
DefoliationMethod <- Grazed[cutDates, on = c("Experiment", "SowingDate" ,"Season", "SDorder",
                        "Clock.Today", "Rotation.No.")
       ][, DefoliationMethod := ifelse(is.na(DefoliationMethod), "Mown", DefoliationMethod)
         ][]
DefoliationMethod <- DefoliationMethod[, GrazingPeriod := ifelse(DefoliationMethod =="Grazed", 5L, 0L)
                  ][Experiment == "Iversen12" & 
                      Season == "2010/11" & 
                      SowingDate %in% paste0("SD", 1:5) &
                      DefoliationMethod == "Grazed",
                    GrazingPeriod := 7L
                    ][Experiment == "AshleyDene" & 
                      Season == "2011/12" & 
                      SowingDate %in% paste0("SD", 1:5) ,
                      GrazingPeriod := fcase(Rotation.No. == 1, 7L,
                                             Rotation.No. == 2, 8L,
                                             Rotation.No. == 5, 5L,
                                             default = 4L
                                             )
                      ][, Dates := Clock.Today + GrazingPeriod + 1L][]
tab_cutDates <- DefoliationMethod %>% 
  dcast.data.table(Season+SowingDate + SDorder + Rotation.No. ~ Experiment, value.var = "Dates" )
tab_cutDates[order(Season, SDorder)
             ][,.(Season, SowingDate, Rotation = Rotation.No., `Ashley Dene` =  AshleyDene, Iversen12)]%>%
  kbl() %>%
  kable_classic()
```

# Results for 4.3.1.2 onwards

## Connect to db and extract the predict and observed
```{r}
conn <- DBI::dbConnect(drv = SQLite(), 
                       here::here("01Data/ApsimxFiles/LucerneValidation.db"))
dbListTables(conn)
sql <- 'SELECT * FROM PredictedObserved INNER JOIN _Simulations ON PredictedObserved.SimulationID = _Simulations.ID'
rs <- dbSendQuery(conn, sql)
pre_obs <- DBI::dbFetch(rs) %>% 
  as.data.table()

sql <- 'SELECT * FROM Report INNER JOIN _Simulations ON Report.SimulationID = _Simulations.ID'
rs <- dbSendQuery(conn, sql)
Report <- DBI::dbFetch(rs) %>% 
  as.data.table()


pre_obs[, Clock.Today:=as.Date(Clock.Today)
        ][, (c("Experiment", "SowingDate")) := tstrsplit(Name, split = "SowingDate")]
setnames(pre_obs, colnames(pre_obs), gsub("[[:punct:]]", ".", colnames(pre_obs)))
Report[, Clock.Today:=as.Date(Clock.Today)]
names(Report) <-   gsub("[[:punct:]]", ".", colnames(Report))

DBI::dbDisconnect(conn)
```
## Soil water profile

```{r}

# 
# pre_obs[,.(Clock.Today, Name, Predicted.SWCmm, Observed.SWCmm)
#         ][, Name := gsub("SowingDate", "", Name)] %>% 
#   ggplot(aes(Observed.SWCmm, Predicted.SWCmm)) +
#   geom_point() +
#   facet_wrap(~ Name, scales = "free")
# pre_obs[,.(Clock.Today, Name, Pred.Obs.SWCmm)] %>% 
#   ggplot(aes(Clock.Today, Pred.Obs.SWCmm)) +
#   geom_point() +
#   facet_wrap(~ Name)
```
## after Reset the soil 

### Time course
```{r, fig.height=10}

variable <- "SWC"
var_unit <- "mm"
var_unit_lab <- paste0("(", var_unit, ")")

pre_col <- paste0("Predicted.", variable, var_unit)
obs_col <- paste0("Observed.", variable, var_unit)
pre_color <- "black"
obs_color <- "#FF0000"
pre_label <- paste("Predicted", variable, var_unit_lab)
obs_label <- paste("Observed", variable, var_unit_lab)


var_subset <- c("Experiment","SowingDate", "Clock.Today",
                pre_col, obs_col)
SWCprofile <- pre_obs[Clock.Today >= "2011-06-25", 
                      ..var_subset]

SWCprofile <- fix_SDorder(SWCprofile)
colnames(SWCprofile)

timestep_colors <- c(pre_color,obs_color)
names(timestep_colors) <- c(pre_col, obs_col)
timestep_labels <- c(pre_label, obs_label)
names(timestep_labels) <- c(pre_col, obs_col)
timestep_p <- SWCprofile %>% 
  ggplot(.,aes(Clock.Today )) +
  geom_point(aes(y = .data[[obs_col]], color = {{obs_col}}),
             size = 3)+
  geom_line(aes(y = .data[[pre_col]], color = {{pre_col}}), show.legend = TRUE,
            size = 1) +
  facet_wrap( ~  SowingDate + Experiment,
              strip.position = "right", nrow = 10, scales = "free_y") +
  theme_water()  +
  theme(legend.position = "none", legend.key.size = unit(1, "cm")) +
  labs(y = paste0(gsub("Predicted\\.|mm", "", pre_col), " (mm)"), 
       x = "Date") +
  scale_colour_manual(name = "col", values = timestep_colors, labels = timestep_labels)
timestep_p
#https://stackoverflow.com/questions/49740215/ggplot-facet-grid-label-cut-off


```
Add DUL to time stamp graph
```{r}
DULmm <- unique(Report[!is.na(DULmm), .(DULmm, Experiment, SowingDate)])
DULmm <- fix_SDorder(DULmm)
p <- timestep_p +
  geom_hline(data = DULmm, aes(yintercept = DULmm), linetype = 2, size = 0.5, 
             alpha = 0.6, inherits =FALSE)

p
# ggsave("Figures/sw_timestamp.png",plot = p, width = 10, height =14, dpi = 320)


```
#### Soil moisture deficit wording

```{r}
SWCmm <- SW_mean_new[ , SWCmm := rowSums(.SD, na.rm = TRUE), 
                      by = .(Experiment,SowingDate, Clock.Today, DAS), 
                      .SDcols = grep("SWmm.\\d.+mean", 
                                     colnames(sw_mean_new), value = TRUE)
                      ][,.(Experiment, SowingDate, Clock.Today, DAS, SWCmm)]
SMD <- SWCmm[order(SWCmm), .SD[1], by = .(Experiment, SowingDate)] 

SMD[DULmm[, SowingDate:=as.character(SowingDate)], 
    on = c("Experiment", "SowingDate")
    ][, SMD.mm := DULmm - SWCmm][order(DAS)]
```


## Biomass and LAI

### Time course graph

#### Graph function
```{r}
plot_timecourse <- function(DT, var, unit, label){
  pre_col <- paste0("Predicted.", var, unit)
  obs_col <- paste0("Observed.", var, unit)
  pre_color <- "black"
  obs_color <- "#FF0000"
  pre_label <- paste("Predicted", var, label)
  obs_label <- paste("Observed", var, label)
  
  var_subset <- c("Experiment","SowingDate", "Clock.Today",
                  pre_col, obs_col)
  DT_sub <- DT[Clock.Today >= "2011-06-25", 
                   ..var_subset]
  DT_sub <- fix_SDorder(DT_sub)
  # label and colour
  timestep_colors <- c(pre_color,obs_color)
  names(timestep_colors) <- c(pre_col, obs_col)
  timestep_labels <- c(pre_label, obs_label)
  names(timestep_labels) <- c(pre_col, obs_col)
  # Graphing
  timestep_p <- DT_sub %>% 
    ggplot(.,aes(Clock.Today )) +
    geom_point(aes(y = .data[[obs_col]], color = {{obs_col}}),
               size = 3)+
    geom_line(aes(y = .data[[pre_col]], color = {{pre_col}}), 
              show.legend = TRUE,size = 1) +
    facet_wrap( ~  SowingDate + Experiment,
                strip.position = "right", nrow = 10, scales = "free_y") +
    theme_water()  +
    theme(legend.position = "none", legend.key.size = unit(1, "cm")) +
    labs(y = paste(gsub("Predicted\\.|mm", "", pre_col), label), 
         x = "Date") +
    scale_colour_manual(name = "col", values = timestep_colors, labels = timestep_labels)
timestep_p
}
```

#### LAI
```{r}
variable <- "LAI"
var_unit <- ""
var_unit_lab <- ""
p_LAI <- plot_timecourse(pre_obs[Clock.Today >= "2011-06-25"], variable, var_unit, var_unit_lab)
ggsave("Figures/LAI_timestamp.png",plot = p_LAI, width = 10, height =14, dpi = 320)

```

#### leaf wt 
```{r}
variable <- "Leaf"
var_unit <- "Wt"
var_unit_lab <- paste0("(kg/ha)")


p_leafwt <- plot_timecourse(pre_obs, variable, var_unit, var_unit_lab)
ggsave("Figures/leaf_timestamp.png",plot = p_leafwt, width = 10, height =14, dpi = 320)

```

#### stem wt

```{r}
variable <- "Stem"
var_unit <- "Wt"
var_unit_lab <- paste0("(kg/ha)")


p_stemwt <- plot_timecourse(pre_obs[Clock.Today >= "2011-06-25"], variable, var_unit, var_unit_lab)
ggsave("Figures/stem_timestamp.png",plot = p_stemwt, width = 10, height =14, dpi = 320)
##QC CHECK
# pre_obs[Clock.Today >= "2011-06-25", .(Experiment, SowingDate, Clock.Today,Predicted.ShootWt, Observed.StemWt)] %>% 
#   ggplot(aes(Clock.Today, Observed.StemWt)) +
#   geom_point() +
#   geom_line(aes(y = Predicted.ShootWt)) +
#   facet_wrap(~ SowingDate + Experiment, nrow = 10, strip.position = "right")
```

#### SHOOT WT
```{r}
variable <- "Shoot"
var_unit <- "Wt"
var_unit_lab <- paste0("(kg/ha)")


p_shootwt <- plot_timecourse(pre_obs, variable, var_unit, var_unit_lab)
ggsave("Figures/shoot_timestamp.png",plot = p_shootwt, width = 10, height =14, dpi = 320)

```

#### height
```{r}
variable <- "Height"
var_unit <- ""
var_unit_lab <- "cm"


p_height <- plot_timecourse(pre_obs[SowingDate %in% paste0("SD",1:5)], variable, var_unit, var_unit_lab)+
  facet_wrap( ~  SowingDate + Experiment,
                strip.position = "right", nrow = 5, scales = "free_y")
ggsave("Figures/height_timestamp.png",plot = p_height, width = 10, height = 7, dpi = 320)

```
#### Phenology

```{r}
variable <- "MS.node.No"
var_unit <- ""
var_unit_lab <- ""


p_node <- plot_timecourse(pre_obs, variable, var_unit, var_unit_lab)

ggsave("Figures/node_timestamp.png",plot = p_node, width = 10, height = 10, dpi = 320)

variable <- "GrowthStage"
var_unit <- ""
var_unit_lab <- ""


p_GS <- plot_timecourse(pre_obs, variable, var_unit, var_unit_lab)

ggsave("Figures/GS_timestamp.png",plot = p_GS, width = 10, height = 10, dpi = 320)


```

### Pre vs obs

function

```{r}
plot_PreObs <- function(dt, col_obs, col_pre, 
                        color = "SowingDate", scale = "fixed"){
  base_p <- dt %>% 
  ggplot(aes(x = .data[[col_obs]],
             y = .data[[col_pre]]
             # shape = SowingDate,
             # colour = .data[[color]]
             )) +
  geom_point(size = 3, alpha = 0.8) +
  facet_wrap( ~ Experiment, scales = scale)
  return(base_p)
}


key_stats <- function(DT, key =c("Experiment"), pre_col, obs_col){
 stats <-  sims_stats(DT, keys = key,
                      col_pred = pre_col,
                      col_obs = obs_col)
 stats_rs <- stats[, unlist(stats, recursive = FALSE), by = .(Experiment)]
 stats_rs[, ':='(R2_str = paste0(as.character(expression(italic(R)^2 ~"=")), "~",R2),
                 NSE_str = paste0(as.character(expression(NSE~"=")), "~", NSE),
                 RMSE_str = paste0(as.character(expression(RMSE~" = ")), "~", RMSE))]
 return(stats_rs)
}
```


```{r}
variable <- "SWC"
var_unit <- "mm"
var_unit_lab <- " (mm)"

pre_col <- paste0("Predicted.", variable, var_unit)
obs_col <- paste0("Observed.", variable, var_unit)
pre_color <- "black"
obs_color <- "#FF0000"
pre_label <- paste("Predicted", variable, var_unit_lab)
obs_label <- paste("Observed", variable, var_unit_lab)


var_subset <- c("Experiment","SowingDate", "Clock.Today",
                pre_col, obs_col)
DT_sub <- pre_obs[Clock.Today >= "2011-06-25",
                      ..var_subset]

DT_sub <- fix_SDorder(DT_sub)

base_p <- DT_sub %>%
  plot_PreObs(., col_obs = obs_col, col_pre = pre_col,scale = "free")+
  theme_water()

# Add stats
abline_p <- base_p+
  geom_abline()+
  geom_smooth(method =  "lm", se = FALSE)

stats_rs <- key_stats(DT_sub, key =c("Experiment"), pre_col, obs_col)
## Has to customise
anchors <- DT_sub[, .(x = min(eval(parse(text = obs_col)), na.rm = TRUE) * 1.1,
                      y = max(eval(parse(text = pre_col)), na.rm = TRUE)* 0.9), 
                  by = .(Experiment)]
stats_rs <- stats_rs[anchors, on = "Experiment"]

abline_p +
  geom_text(data = stats_rs,
            aes( x = x,  y = y, label = NSE_str), parse = TRUE,
            inherit.aes = FALSE) +
  geom_text(data = stats_rs,
            aes( x = x,  y = y*1.02, label = R2_str), parse = TRUE,
            inherit.aes = FALSE) +
  geom_text(data = stats_rs,
            aes( x = x,  y = y*0.98, label = RMSE_str), parse = TRUE,
            inherit.aes = FALSE) +
  labs(y = paste0(gsub("\\.|mm", " ", pre_col), var_unit_lab),
       x = paste0(gsub("\\.|mm", " ", obs_col), var_unit_lab))
ggsave("Figures/swc_preobs.png", width = 10, height =5, dpi = 320)
```


```{r}
variable <- "LAI"
var_unit <- ""
var_unit_lab <- ""

pre_col <- paste0("Predicted.", variable, var_unit)
obs_col <- paste0("Observed.", variable, var_unit)
pre_color <- "black"
obs_color <- "#FF0000"
pre_label <- paste("Predicted", variable, var_unit_lab)
obs_label <- paste("Observed", variable, var_unit_lab)


var_subset <- c("Experiment","SowingDate", "Clock.Today",
                pre_col, obs_col)
DT_sub <- pre_obs[Clock.Today >= "2011-06-25",
                      ..var_subset]

DT_sub <- fix_SDorder(DT_sub)
colnames(DT_sub)

base_p <- DT_sub %>%
  plot_PreObs(., col_obs = obs_col, col_pre = pre_col)+
  theme_water()

# Add stats
abline_p <- base_p+
  geom_abline()+
  geom_smooth(method =  "lm", se = FALSE)

stats_rs <- key_stats(DT_sub, key = c("Experiment"),
                       pre_col, obs_col)

anchors <- data.table(Experiment = c("AshleyDene", "Iversen12"), x = 6, y = 1)
stats_rs <- stats_rs[anchors, on = "Experiment"]

abline_p +
  geom_text(data = stats_rs,
            aes( x = x,  y = y, label = NSE_str), parse = TRUE,
            inherit.aes = FALSE) +
  geom_text(data = stats_rs,
            aes( x = x,  y = y*1.3, label = R2_str), parse = TRUE,
            inherit.aes = FALSE) +
  geom_text(data = stats_rs,
            aes( x = x,  y = y*0.7, label = RMSE_str), parse = TRUE,
            inherit.aes = FALSE) +
  labs(y = paste0(gsub("\\.|mm", " ", pre_col), var_unit_lab),
       x = paste0(gsub("\\.|mm", " ", obs_col), var_unit_lab))
ggsave("Figures/LAI_preobs.png", width = 10, height =5, dpi = 320)
```


```{r}

```

### Shootwt
```{r}
variable <- "Shoot"
var_unit <- "Wt"
var_unit_lab <- " (kg/ha)"

pre_col <- paste0("Predicted.", variable, var_unit)
obs_col <- paste0("Observed.", variable, var_unit)
pre_color <- "black"
obs_color <- "#FF0000"
pre_label <- paste("Predicted", variable, var_unit_lab)
obs_label <- paste("Observed", variable, var_unit_lab)


var_subset <- c("Experiment","SowingDate", "Clock.Today",
                pre_col, obs_col)
DT_sub <- pre_obs[Clock.Today >= "2011-06-25", 
                      ..var_subset]

DT_sub <- fix_SDorder(DT_sub)
colnames(DT_sub)

base_p <- DT_sub %>% 
  plot_PreObs(., col_obs = obs_col, col_pre = pre_col)+
  theme_water()

# Add stats
abline_p <- base_p+
  geom_abline()+
  geom_smooth(method =  "lm", se = FALSE)


anchors <-  data.table(Experiment = c("AshleyDene", "Iversen12"), 
                       x = c(3000,1000), y = c(1000,3000))
stats_rs <- key_stats(DT_sub, key = c("Experiment"),
                    pre_col, obs_col)

stats_rs <- stats_rs[anchors, on = "Experiment"]


abline_p +
  geom_text(data = stats_rs, 
            aes( x = x,  y = y, label = NSE_str), parse = TRUE,
            inherit.aes = FALSE) +
  geom_text(data = stats_rs, 
            aes( x = x,  y = y + 200, label = R2_str), parse = TRUE,
            inherit.aes = FALSE) +
  geom_text(data = stats_rs, 
            aes( x = x,  y = y - 200, label = RMSE_str), parse = TRUE,
            inherit.aes = FALSE) +
  labs(y = paste0(gsub("\\.|mm", " ", pre_col), var_unit_lab),
       x = paste0(gsub("\\.|mm", " ", obs_col), var_unit_lab))

ggsave("Figures/Shoot_preobs.png", width = 10, height =5, dpi = 320)
```

