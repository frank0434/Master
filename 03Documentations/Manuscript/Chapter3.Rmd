---
title: "Chapter4"
author: "jian (AKA Frank) liu"
date: "17/01/2021"
output:
  html_document:
    df_print: paged
  word_document:
    reference_docx: dissertationTemplate.docx
always_allow_html: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 10, fig.height = 7, 
                      dpi = 300)
options(scipen = 999)
#Constants
outlier.colour = "#ff0000"
source(here::here("02Scripts/R/packages.R"))
source(here::here("02Scripts/R/functions.R"))
path_richard <- "C:/Users/cflfcl/Dropbox/Data/APSIM_Sim.xlsx"
id_vars <- c("Experiment", "SowingDate", "Clock.Today", "DAS")

data_sw <- read_Sims(path = path_richard)

value_vars <-  grep("SWmm\\.\\d.", colnames(data_sw), value = TRUE)
sw_mean_new <- colwise_meanSW(data_sw)

# Colour p
blues <- c("#0f5e9c",
           "#2389da",
           "#1ca3ec",
           "#5abcd8",
           "#74ccf4")
names(blues) <- blues 
ggplot(data.frame(x = blues, y = 1),aes(x, y, fill = x)) +
  geom_col() +
  scale_fill_manual(name = "", values = blues)+
  theme_void()
linesize <- 1
pointsize <-  2
labelsize <- 4
magicDate <- "2011-06-25"
```

### LEAR response to temp and photoperiod
```{r}


x = c(1, 15, 30, 40)
y = c(0, 10, 25, 0)
lab = c("T[b]", "T[i]", "T[o]", "T[m]")
df_tt <- data.frame(x =  x, y =  y, z = lab)
p_tt <- df_tt %>% 
  ggplot(aes(x, y )) +
  geom_line(size = linesize) + 
  geom_text(aes( y = y +3, label =  bquote(.(z))), size = 12, nudge_x = 1, nudge_y = 1,
            parse = TRUE) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 35))+
  scale_x_continuous(expand = c(0,0), limits = c(0, 43)) +
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = "Air Temperature (\u00B0C)", 
        y = "Thermal time (\u00B0Cd)")

a = c(8, 10, 16.5,  11.5, 12, 16.5)
b = c(0, 0.0056, 0.015,  0, 0.018, 0.02)
lab = c(rep("Decreasing", 3), rep("Increasing", 3))
df_pp <- data.frame(a , b , lab)
p_pp <- df_pp %>% 
  ggplot(aes(a , b)) +
  geom_line(size = linesize) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 0.025))+
  scale_x_continuous(expand = c(0,0), limits = c(7, 17), n.breaks = 7) +
  facet_wrap(~ lab) +
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = "Photoperiod (h)", 
        y = bquote("LEAR (m"^2~" m"^-2~" \u00B0Cd)") )

p_LEAR <- plot_grid(p_tt, p_pp, ncol = 1, align = "v", axis = "lr")
ggsave("Figures/ch3_LEAR.png",plot = p_LEAR,
       width = 7, height = 7, dpi = 320)
```

### LEAR on water stress levels 

```{r}

linesize <- 1
x <- seq(0, 0.9, by = 0.1)
y <- 0.03 * x - 0.009
optLEAR <- 0.018
df_tt <- data.frame(x =  x, y =  ifelse(y<0 , NA, y))
p_tt <- df_tt %>% 
  ggplot(aes(x, y )) +
  geom_line(size = linesize) + 
  geom_hline(yintercept =  optLEAR, linetype = 2, size = linesize)+
  scale_y_continuous(expand = c(0,0), limits = c(0, 0.020))+
  scale_x_continuous(expand = c(0,0), limits = c(0, 1.3), 
                     labels = sprintf("%.1f", seq(0, 1.2, by = 0.2)),
                     breaks = seq(0, 1.2, by = 0.2)) +
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = bquote("T/T"[D]), 
        y = bquote("LEAR (LAI/\u00B0Cd)"))

ggsave("Figures/ch3_LEARStress.png",plot = p_tt,
       width = 7, height = 5, dpi = 320)
```

### RUE

#### figure 2.6
```{r}
y <- round(runif(10, 0.8, 0.9), digits = 2)




```

```{r}
x = c(0	,18,30, 40)
y = c(0,1.1,1.1, 0)

df_rue <- data.frame(x , y)
p_rue <- df_rue %>% 
  ggplot(aes(x, y)) +
  geom_line(size = linesize) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 1.5))+
  scale_x_continuous(expand = c(0,0), limits = c(0, 42), n.breaks = 7) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = "Mean Air Temperature (\u00B0C)", 
        y = bquote("RUE (g DM MJ"^-1~")") )
p_rue
ggsave("Figures/ch3_rue.png",plot = p_rue,
       width = 7, height = 3.5, dpi = 320)

x = c(0,0.15,0.75,0.9,1)
y = c(0,0.4,0.75,1,1)
df_rue_fw <- data.frame(x , y)
p_rue_fw <- df_rue_fw %>% 
  ggplot(aes(x, y)) +
  geom_line(size = linesize) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 1.1))+
  scale_x_continuous(expand = c(0,0), limits = c(0, 1.1), n.breaks = 7) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = bquote("T/T"["D"]), 
        y = bquote(italic("f"["stressed"]~"/f"["optimal"]) ))
ggsave("Figures/ch3_rue_FW.png",plot = p_rue_fw,
       width = 7, height = 3.5, dpi = 320)

```

### Phyllochron
```{r}
a = c(10, 16.5,  10, 12, 16.5)
b = c(49, 35, 49,  31, 31)
lab = c(rep("Decreasing", 2), rep("Increasing", 3))
df_pp <- data.frame(a , b , lab)
p_pp <- df_pp %>% 
  ggplot(aes(a , b)) +
  geom_line(size = linesize) +
  scale_y_continuous(expand = c(0,0), limits = c(30, 50))+
  scale_x_continuous(expand = c(0,0), limits = c(9, 18), n.breaks = 7) +
  facet_wrap(~ lab) +
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16),
        panel.spacing = unit(5, "mm")) +
  labs( x = "Photoperiod (h)", 
        y = bquote("Phyllochron (\u00B0Cd)") )
ggsave("Figures/ch3_phyllochron.png",plot = p_pp,
       width = 7, height = 3.5, dpi = 320)

```

### Water stress on phyllochron
```{r}
a=c(0, 0.5,  0.7, 1)
b=c(2, 2,  1, 1)
df_ph_fw <- data.frame(a, b)
p_ph_fw <- df_ph_fw %>% 
  ggplot(aes(a, b)) +
  geom_line(size = linesize) +
  scale_y_continuous(expand = c(0,0), limits = c(0.8, 2.2))+
  scale_x_continuous(expand = c(0,0), limits = c(0,1.1)) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = bquote("T/T"["D"]), 
        y = bquote("f"["stressed"]~"/f"["optimal"]) )
ggsave("Figures/ch3_ph_fw.png",plot = p_ph_fw,
       width = 7, height = 3.5, dpi = 320)
```
### Heightchron
```{r}
a = seq(8, 16.5, by = 0.5)
b = 0.62 + 9766 * exp(a*-1)
df_height <- data.frame(a, b)
p_height <- df_height %>% 
  ggplot( aes(a,b))+
  geom_line(size = linesize)+
  # scale_y_continuous(exp+
  scale_x_continuous(expand = c(0,0)) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = bquote("Photoperiod (h)"), 
        y = bquote("Heightchron ( ËšCd mm "^-1~")") )
p_height
ggsave("Figures/ch3_p_height.png",plot = p_height,
       width = 7, height = 3.5, dpi = 320)
```


### Flowering?
```{r}
DT <- as.data.table(read_excel(path_richard, sheet = 2, skip = 9,
                               guess_max = 10000, .name_repair = "universal"))
pheno <- DT[Data == "Phenology"]
cols <- choose_cols(pheno)
pheno <- pheno[,..cols]
pheno %>% 
  ggplot(aes(Date, Fi_No)) +
  geom_point() +
  facet_wrap( Site ~ Sowing.Date)
## number 1 to 10 represent how many branches 
pheno[, Fi:=Fi/10]

dt <- pheno[, .(meanfi = mean(Fi, na.rm = TRUE)), 
            by = .(Site, Sowing.Date, Date)
            ][!is.nan(meanfi)]

dt %>% 
  ggplot(aes(Date, meanfi, color = Sowing.Date)) +
  geom_point() +
  facet_wrap( ~Site )


```


## Fig2.8
```{r}

inti <- 30
x = seq(inti + 1, inti + 100, by = 1)

y = 0.1 + 0.25 * exp(-0.06 * (x - inti))
set.seed(42)
z <- seq(1,100, by = 5)
# noise <- jitter(y[z], 200)
# plot(x,y)
# plot(x,noise)
dt <- data.table(x = x, y = y)
dt[z, noise := jitter(y, 200)]

dt_int <- data.table(x = 1:inti, y = y[1])
dt_int[seq(1, inti, by = 5), noise := jitter(y, 0.5)]
dt <- rbindlist(list(dt_int, dt))
dt %>% 
  ggplot(aes(x, y))+
  geom_line(size = linesize) +
  geom_point(aes(y = noise), size = pointsize) +
  theme_water() +
  theme(text = element_text(size = 16), 
        axis.ticks.x = element_blank(),
        axis.text.x = element_blank()) +
  labs(x = "Time",
       y = bquote("Soil water content ("~theta~", mm"^3~"mm"^-3~")"))+
  scale_x_continuous(expand = c(0, 0),limits = c(0, 131))+
  # add the line to indicate RFV
  geom_vline(xintercept = inti + 1, linetype = 5, size = linesize) +
  annotate("text", x = dt$x[15], y = dt$y[35],
           label = bquote(bold("Stage A")),size = labelsize)+
  annotate("text", x = dt$x[70], y = dt$y[35],
           label = bquote(bold("Stage B")),size = labelsize)+
  annotate("text", x = dt$x[120], y = 0.225,
           label = bquote(atop(bold("PAWC"),
                               ~(italic(theta[DUL]~ - ~theta[CLL])))),size = labelsize)+
  annotate("segment", x = dt$x[120], xend = dt$x[120], y = 0.2, yend = dt$y[110], size=0.8, alpha=0.8, 
           arrow=arrow(length = unit(5, "mm"))) +
  annotate("segment", x = dt$x[120], xend = dt$x[120], y = 0.25, yend = dt$y[1], size=0.8, alpha=0.8, 
           arrow=arrow(length = unit(5, "mm"))) +
  annotate("segment", x = inti + 15, xend = inti + 1, y = dt$y[32], yend = dt$y[1], size=0.8, alpha=0.8, 
           arrow=arrow(length = unit(5, "mm"))) +
  annotate("segment", x = dt$x[115], xend = dt$x[125], y =  dt$y[1], yend = dt$y[1], size=0.8) +
  annotate("segment", x = dt$x[115], xend = dt$x[125], y =  0.1, yend = 0.1, size=0.8) +
  # Add the text for dul and ll
  annotate("text", x = dt$x[120], y =  dt$y[110]-0.01, label = bquote(italic(~theta[CLL])),size = labelsize) +
  annotate("text", x = dt$x[120], y =  dt$y[1]+0.01, label = bquote(italic(~theta[DUL])),size = labelsize) +
  annotate("text", x = inti + 18, y =  dt$y[32], label = bquote(italic(~t[c])),size = labelsize) 
ggsave("Figures/fig2.8.png",
       width = 7, height = 5, dpi = 320)
```
### fIG 2.9


```{r}


inti <- 6
x = seq(inti + 1, inti + 12, by = 0.05)

y = 1 + 7 * exp(-1 * (x - inti))
# set.seed(42)
z <- seq(1, length(x), by = 5)
dt <- data.table(x = x, y = y)
dt[z, noise := jitter(y, 40)]

dt_int <- data.table(x = seq(1, inti, by = 0.5), y = y[1])
dt_int[seq(1, nrow(dt_int), by = 1), noise := jitter(y, 1)]
dt <- rbindlist(list(dt_int, dt))
dt %>% 
  ggplot(aes(x, y))+
  # geom_line(size = linesize) +
  geom_point(aes(y = noise), size = pointsize) +
  theme_water() +
  theme(text = element_text(size = 16)        ) +
  labs(x = "Time (days)",
       y = bquote("Evaporation rate (mm"~" day"^-1~")"))+
  scale_x_continuous(expand = c(0, 0),limits = c(2, 15),
                     breaks = seq(2, 14, by = 2),
                     labels = seq(2, 14, by = 2))+
  scale_y_continuous(expand = c(0, 0),limits = c(0,5))+
  # add the line to indicate RFV
  geom_vline(xintercept = inti + 1, linetype = 5, size = linesize) +
  annotate("text", x = dt$x[7], y = 2,
           label = bquote(bold("Stage I")),size = 5)+
  annotate("text", x = dt$x[75], y = 2,
           label = bquote(bold("Stage II")),size = 5)
  # annotate("text", x = dt$x[120], y = 0.225,
  #          label = bquote(atop(bold("PAWC"),
  #                              ~(italic(theta[DUL]~ - ~theta[CLL])))),size = labelsize)+
  # annotate("segment", x = dt$x[120], xend = dt$x[120], y = 0.2, yend = dt$y[110], size=0.8, alpha=0.8, 
  #          arrow=arrow(length = unit(5, "mm"))) +
  # annotate("segment", x = dt$x[120], xend = dt$x[120], y = 0.25, yend = dt$y[1], size=0.8, alpha=0.8, 
  #          arrow=arrow(length = unit(5, "mm"))) +
  # annotate("segment", x = inti + 15, xend = inti + 1, y = dt$y[32], yend = dt$y[1], size=0.8, alpha=0.8, 
  #          arrow=arrow(length = unit(5, "mm"))) +
  # annotate("segment", x = dt$x[115], xend = dt$x[125], y =  dt$y[1], yend = dt$y[1], size=0.8) +
  # annotate("segment", x = dt$x[115], xend = dt$x[125], y =  0.1, yend = 0.1, size=0.8) +
  # # Add the text for dul and ll
  # annotate("text", x = dt$x[120], y =  dt$y[110]-0.01, label = bquote(italic(~theta[CLL])),size = labelsize) +
  # annotate("text", x = dt$x[120], y =  dt$y[1]+0.01, label = bquote(italic(~theta[DUL])),size = labelsize) +
  # annotate("text", x = inti + 18, y =  dt$y[32], label = bquote(italic(~t[c])),size = labelsize) 
ggsave("Figures/fig2.9.png",
       width = 7, height = 5, dpi = 320)

```

