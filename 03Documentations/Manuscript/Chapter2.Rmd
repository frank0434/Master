---
title: "Chapter4"
author: "jian (AKA Frank) liu"
date: "17/01/2021"
output:
  html_document:
    df_print: paged
  word_document:
    reference_docx: dissertationTemplate.docx
always_allow_html: yes
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 10, fig.height = 7, 
                      dpi = 300)
options(scipen = 999)
#Constants
outlier.colour = "#ff0000"
source(here::here("02Scripts/R/packages.R"))
source(here::here("02Scripts/R/functions.R"))
path_richard <- "C:/Users/cflfcl/Dropbox/Data/APSIM_Sim.xlsx"

theme_frnl <- function(){
  theme_bw() +
  theme(strip.background = element_blank(),
        strip.placement = "outside",
        plot.background = element_rect(inherit.blank = T),
        plot.caption = element_text(hjust = 0.5, size = rel(2)),
        legend.direction = "horizontal",
        legend.title = element_blank(),
        legend.key = element_blank(),
        legend.position = "bottom",
        panel.background = element_rect(fill = "white",colour = "grey"))
}
```

## Converting cutting frequencies to acuumulate thermal time

Read the france weather data

$T_b = 5^oC\ \ \ \ \ if\ T > 15^o$ in France  

Thiébeau, P., Beaudoin, N., Justes, E., Allirand, J.-M., & Lemaire, G. (2011). Radiation use efficiency and shoot:root dry matter partitioning in seedling growths and regrowth crops of lucerne (Medicago sativa L.) after spring and autumn sowings. European Journal of Agronomy, 35(4), 255–268. https://doi.org/10.1016/j.eja.2011.07.002

Baldissera, T. C., Frak, E., Carvalho, P. C. de F., & Louarn, G. (2014). Plant development controls leaf area expansion in alfalfa plants competing for light. Annals of Botany, 113(1), 145–157. https://doi.org/10.1093/aob/mct251
$T_b = 1^oC$ in NZ  


```{r}
france <- readxl::read_excel(here::here("01Data/ClimateAndObserved/Lusignan_Quo_1994_RR_TN-TX.xlsx")) %>% 
  as.data.table()
# check if min > max; any NAs
temp <- france[, .(DATE, TN, TX)]
temp[which(TX<TN)];temp[is.na(TX)]; temp[is.na(TN)]

```

```{r}

dailyTT <- weaana::thermalTimeDaily(temp$TN,
                                    temp$TX,
                                    method = "3hr",
                                    x_temp = c(1,15,30,40), # LUCERNE CARDINAL 
                                     y_temp = c(0,10,25,0)) # EFFECTIVE TT

dailyTT <- as.data.table(dailyTT)
dailyTT[, Date := temp$DATE]


```
a fre- quent cutting treatment (first cut on 5May, followedby 2 harvests at 30-day intervals i.e. on 6 June and 6 July) or an infrequent cutting treatment (first cut on 24 May, followed by a harvest at a 45-day regrowth interval


```{r}
# 30 days
cut1 <- dailyTT[Date > "1994-05-05" & (Date < "1994-07-06")
                ][, interval := ifelse(Date <= "1994-06-05", 1, 2)
                  ][, cumTT := cumsum(dailyTT), by = . (interval)]
cut1[, max(cumTT), by = .(interval)
     ][, list(mean = mean(V1), sd = sd(V1))]
# 45 days
cut2 <- dailyTT[Date > "1994-05-24" & (Date <= "1994-07-06")
                ][, cumTT := cumsum(dailyTT)]

cut2[, max(cumTT)]
```

```{r}

library(clifro)
library(data.table)
library(lubridate)
cf_find_station("lincoln", search = "name") # not working any more

lincoln = cf_station(17603)
me <-  cf_user("frank0434",password = getPass::getPass())
my.dts <- cf_datatype(c(4), #temperature, radiation - 1,2,3 in this template
                      c(2),
                      list(2), # hourly and daily
                      c(NA))


cf.datalist <- cf_query(user = me,
                        datatype = my.dts,
                        station = lincoln,
                        start_date = "2002-09-18 00",
                        end_date = "2004-06-13 00")

# converting into the df --------------------------------------------------
nz <- as.data.table(cf.datalist)
```

```{r}
temp <- nz[, .(Date = `Date(local)`, TN = `Tmin(C)`, TX = `Tmax(C)`)]
temp[which(TX<TN)];temp[is.na(TX)]; temp[is.na(TN)]
# fill the NA with previous year value
temp[Date =="2003-06-02"]
temp[is.na(TN), TN:= temp[Date =="2003-06-02"]$TN]
temp[, Tmean := (TN+TX)/2]
```

```{r}
# Effective thermal time 

dailyTT <- weaana::thermalTimeHourly(temp$Date, 
                                     temperature = temp$Tmean,
                                     x_temp = c(1,15,30,40), # LUCERNE CARDINAL 
                                     y_temp = c(0,10,25,0)) # EFFECTIVE TT

dailyTT <- as.data.table(dailyTT)



```
1 st growth season 2002/03
Actual experimental period
From 14 June 2002 to 12 June 2003
2nd growth season 2003/04
From 13 June 2003 to 12 June 2004

Sep 18 2002 starts the SS regrowth period to 8 true 28 cycles? 

```{r}
intervals <- 28
first <- as.Date("2002-09-18") + intervals
second <- first + intervals
thrid <- second + intervals

l <- list()
init <- as.Date("2002-09-18")
i <- 1L
while(init < "2004-06-14"){
  first <- init + intervals
  init <- first
  l[i] <- init
  i <- i + 1L
}

l %>%
  unlist() %>% 
  as.Date(origin = "1970-01-01")
```
too complex 
found information from the thesis 


```{r}
init <- as.Date(c("2002-09-20",
          "2002-10-18",
          "2002-11-14",
          "2002-12-12",
          "2003-01-09",
          "2003-02-11",
          "2003-03-08",
          "2003-04-05"))

intervals <- c(25,23,24,24,29,21,25,28)
period <- init + intervals
# dailyTT[date > init[1] & (date < period[1]), interval := 1][]
l <- vector(mode = "list", length = length(init))
for( i in seq_len(length(init))){
  print(i)
  DT <- dailyTT[(date >= init[i]) & (date <= period[i]), interval := i]
  l[[i]] <- DT[!is.na(interval)]

  
}
DT[!is.na(interval)
   ][, cumTT:=cumsum(value), by = .(interval)
     ][, max(cumTT), by = .(interval)
       ][, list(mean = mean(V1),
                sd = sd(V1))]
```

### LEAR response to temp and photoperiod
```{r}


x = c(1, 15, 30, 40)
y = c(0, 10, 25, 0)
lab = c("T[b]", "T[i]", "T[o]", "T[m]")
df_tt <- data.frame(x =  x, y =  y, z = lab)
p_tt <- df_tt %>% 
  ggplot(aes(x, y )) +
  geom_line(size = 1.5) + 
  geom_text(aes( y = y +3, label =  bquote(.(z))), size = 12, nudge_x = 1, nudge_y = 1,
            parse = TRUE) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 35))+
  scale_x_continuous(expand = c(0,0), limits = c(0, 43)) +
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = "Air Temperature (\u00B0C)", 
        y = "Thermal time (\u00B0Cd)")

a = c(8, 10, 16.5,  11.5, 12, 16.5)
b = c(0, 0.0056, 0.015,  0, 0.018, 0.02)
lab = c(rep("Decreasing", 3), rep("Increasing", 3))
df_pp <- data.frame(a , b , lab)
p_pp <- df_pp %>% 
  ggplot(aes(a , b)) +
  geom_line(size = 1.5) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 0.025))+
  scale_x_continuous(expand = c(0,0), limits = c(7, 17), n.breaks = 7) +
  facet_wrap(~ lab) +
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = "Photoperiod (h)", 
        y = bquote("LEAR (m"^2~"/m"^2~" \u00B0Cd)") )

p_LEAR <- plot_grid(p_tt, p_pp, ncol = 1, align = "v", axis = "lr")
ggsave("Figures/ch3_LEAR.png",plot = p_LEAR,
       width = 7, height = 7, dpi = 320)
```

### RUE
```{r}
x = c(0	,18,30,40)
y = c(0,1.1,1.1,0)

df_rue <- data.frame(x , y)
p_rue <- df_rue %>% 
  ggplot(aes(x, y)) +
  geom_line(size = 1.5) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 1.5))+
  scale_x_continuous(expand = c(0,0), limits = c(0, 42), n.breaks = 7) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = "Mean Air Temperature (\u00B0C)", 
        y = bquote("RUE (g DM MJ"^-1~")") )
p_rue
ggsave("Figures/ch3_rue.png",plot = p_rue,
       width = 7, height = 3.5, dpi = 320)

x = c(0,0.15,0.75,0.9,1)
y = c(0,0.4,0.75,1,1)
z = c(0, 0.15* (1/0.9), 0.75 * (1/0.9), 1, 1)
df_rue_fw <- data.frame(x , y, z)
p_rue_fw <- df_rue_fw %>% 
  ggplot(aes(x, y)) +
  geom_line(aes(y = z), linetype = 3, size = 1.5)+
  geom_line(size = 1.5) +
  scale_y_continuous(expand = c(0,0), limits = c(0, 1.1))+
  scale_x_continuous(expand = c(0,0), limits = c(0, 1.1), n.breaks = 7) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = bquote("T/T"["D"]), 
        y = bquote("f"["stressed"]~"/f"["optimal"]) )
ggsave("Figures/ch3_rue_FW.png",plot = p_rue_fw,
       width = 7, height = 3.5, dpi = 320)

```

### Phyllochron
```{r}
a = c(10, 16.5,  10, 12, 16.5)
b = c(49, 35, 49,  31, 31)
lab = c(rep("Decreasing", 2), rep("Increasing", 3))
df_pp <- data.frame(a , b , lab)
p_pp <- df_pp %>% 
  ggplot(aes(a , b)) +
  geom_line(size = 1.5) +
  scale_y_continuous(expand = c(0,0), limits = c(30, 50))+
  scale_x_continuous(expand = c(0,0), limits = c(9, 18), n.breaks = 7) +
  facet_wrap(~ lab) +
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16),
        panel.spacing = unit(5, "mm")) +
  labs( x = "Photoperiod (h)", 
        y = bquote("Phyllochron (\u00B0Cd)") )
ggsave("Figures/ch3_phyllochron.png",plot = p_pp,
       width = 7, height = 3.5, dpi = 320)

```

### Water stress on phyllochron
```{r}
a=c(0, 0.5,  0.7, 1)
b=c(2, 2,  1, 1)
df_ph_fw <- data.frame(a, b)
p_ph_fw <- df_ph_fw %>% 
  ggplot(aes(a, b)) +
  geom_line(size = 1.5) +
  scale_y_continuous(expand = c(0,0), limits = c(0.8, 2.2))+
  scale_x_continuous(expand = c(0,0), limits = c(0,1.1)) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = bquote("T/T"["D"]), 
        y = bquote("f"["stressed"]~"/f"["optimal"]) )
ggsave("Figures/ch3_ph_fw.png",plot = p_ph_fw,
       width = 7, height = 3.5, dpi = 320)
```
### Heightchron
```{r}
a = seq(8, 16.5, by = 0.5)
b = 1.62 + 19766 * exp(a*-1)
df_height <- data.frame(a, b)
p_height <- df_height %>% 
  ggplot( aes(a,b))+
  geom_line(size = 1.5)+
  # scale_y_continuous(exp+
  scale_x_continuous(expand = c(0,0)) +
  
  theme_classic()+
  theme(panel.background = element_rect(fill = NA, colour = "black"),
        text = element_text(size = 16)) +
  labs( x = bquote("Photoperiod (h)"), 
        y = bquote("Heightchron ( ˚Cd mm "^-1~")") )
p_height
ggsave("Figures/ch3_p_height.png",plot = p_height,
       width = 7, height = 3.5, dpi = 320)
```


### Flowering?
```{r}
DT <- as.data.table(read_excel(path_richard, sheet = 2, skip = 9,
                               guess_max = 10000, .name_repair = "universal"))
pheno <- DT[Data == "Phenology"]
cols <- choose_cols(pheno)
pheno <- pheno[,..cols]
pheno %>% 
  ggplot(aes(Date, Fi_No)) +
  geom_point() +
  facet_wrap( Site ~ Sowing.Date)
## number 1 to 10 represent how many branches 
pheno[, Fi:=Fi/10]

dt <- pheno[, .(meanfi = mean(Fi, na.rm = TRUE)), 
            by = .(Site, Sowing.Date, Date)
            ][!is.nan(meanfi)]

dt %>% 
  ggplot(aes(Date, meanfi, color = Sowing.Date)) +
  geom_point() +
  facet_wrap( ~Site )


```

