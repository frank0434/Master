---
title: "Data_acquisition"
author: "jian (AKA Frank) liu"
date: "04/10/2019"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 3
---

```{r setup, include=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
source("../R/packages.R")
source("../R/functions.R")
```


## Import data from apsimx

* All phenotype data are stored in `Excel` files on [the apsimx github account](https://github.com/APSIMInitiative/ApsimX/tree/master/Prototypes/Lucerne).

* All weather files are in the `.met` format and also available on github.

* Soil data and N content of crop component data are mixed in the `Excel` files, which may require sub-setting. 

* A copy of Richard's data (plant, soil moisture and weather) are in the local hard drive. 

**Plan**

1. clone the repo to local 
   _path:_  "C:/Data/latest_apsimx/ApsimX/Prototypes/Lucerne"
2. read necessary Excel files
3. tidy up 
4. join up
5. store in SQLite


### Browser the data folder

```{r browser the data folder}
path_apX <- "../Data/Lucerne/"
xlsxs <- list.files(path_apX, pattern = "^\\w.+\\.xlsx")
xlsxs
```

_Note_

Need to explore what data inside these `Excel` files


```{r try out new pkg and exam file 1}
exam_xlsxs(path_apX, xlsxs[1])
```

File `r file.path(path_apX, xlsxs[1])` has the expts done in Lincoln. 


```{r exam file 2}
exam_xlsxs(path_apX, xlsxs[2])
```

File `r file.path(path_apX, xlsxs[2])` is from **Argentina**. Seems only the data from `Elliot` has water relative information with total number of obs at 26. 

```{r exam file 3}
exam_xlsxs(path_apX, xlsxs[3])

```

File `r file.path(path_apX, xlsxs[3])` is from **AshleyDene**. Must be the Richard data. 

```{r exam file 4}
exam_xlsxs(path_apX, xlsxs[4])

```

File `r file.path(path_apX, xlsxs[4])` probably is not immediately useful. 


```{r exam file 5}
exam_xlsxs(path_apX, xlsxs[5])

```

File `r file.path(path_apX, xlsxs[5])` could be a validation set???


```{r exam file 6}
# exam_xlsxs(path_apX, xlsxs[6])

```

File `r file.path(path_apX, xlsxs[6])` has data from lincoln, ashleydene and other places over a few years period. need more metadata if want to use this one for any purpose. 


```{r exam file 7}
exam_xlsxs(path_apX, xlsxs[7])

```

File `r file.path(path_apX, xlsxs[7])` seems a duplicated version of last file. Is `Total_SW` for total soil water?? 



```{r exam file 8}
exam_xlsxs(path_apX, xlsxs[8])

```

File `r file.path(path_apX, xlsxs[8])` is not immediately useful. 



File `r file.path(path_apX, xlsxs[9]) ` & `r file.path(path_apX, xlsxs[10])` are duplicated?? need to confirm with Xiumei. 

```{r exam file 11}
exam_xlsxs(path_apX, xlsxs[11])

```

File `r file.path(path_apX, xlsxs[11])` is not immediately useful. 

```{r exam file 12}
exam_xlsxs(path_apX, xlsxs[12])

```

File `r file.path(path_apX, xlsxs[12])` is not immediately useful. 


_Note_

1. Need metadata for variable names 
2. Trial design and data collection method (probabaly in the papers?)
3. Soil information for water expts (papers?)
4. Extract all water relevant data and integrate together? 


```{r}
l <- lapply(xlsxs[-c(6,9,10)], function(x){
  exam_xlsxs(path_apX, x)
  
})
names(l) <- xlsxs[-c(6,9,10)]
potentials <- rbindlist(l, idcol = "id")
potentials <- potentials[, water := stringr::str_extract(string = tolower(value), "water|irr|dry|ashley")][!is.na(water)]
potentials
```

**total number of obs is `r sum(potentials$cnt)`**
There is no Iversen_12 for Richard 10 sowing date expt? 


## Richard data set

```{r richard}
path_richard = "../Data/APSIM_Sim_allobs.txt"
# file_richard = read_excel(path_richard,
#                           skip = 9, 
#                           col_types = c("text","text","date","text","text",
#                                         rep("numeric", 117)))

dt <- fread(path_richard, skip = 9, na.strings = c("","NA"), select = 1:118)
dt <- dt[-nrow(dt), ]#excluded the * 
# dt <- dt[, Date := dmy(Date)] # keep data as chr since sqlite does not support ISO date
dt <- dt %>% 
  as_tibble(.name_repair = "universal") %>% # use tibble format to fix the names 
  as.data.table() # change it back to data.table


dt_SD_lookup <- fread(path_richard, skip = 9, na.strings = c("","NA"), select = 120:122)
dt_SD_lookup <- dt_SD_lookup[!is.na(AD)]
```

what **S AND E** MEANS? SOWING AND EMERGE?
Alpha|	Growth Stage|		No.
 ---|---|---
S|	Sowing	|	1
E	|Emergence	|	3
J	|Juvenile	|	4
Fi|	Visible Bud	|	5
Fl | Flower Open	|	6


_Note_
Richard excel file has mix variable types. `read_excel` has trouble to deal with it. try python's pandas
_Solution_ manually save it to `.txt`, `fread` can handle the type of variables 


### inspect the data

```{r main table}
colnames(dt)
tbl <- inspect_cat(dt) %>% 
  arrange(desc(cnt)) 
head(tbl)

```

_couldn't use `inspect_cat` because of duplicated colnames?_ Fixed by using `.name_repair` in `as_tibble`

There are two `Plant No.` variables.
One is the harvest area plant number and the other one is the plant number per $m^2$

_Note:_

1. the number of obs for Total.DM is larger than the obs for Total FW?
   **not really - there are missing values have been coded as 0**

2. there are multiply tables in one sheet. need to separate into different tables 



```{r main table col}
sapply(dt[,1:2], unique)
```


_Note_ 
1. Need to figure out what `ES` and `*` stands for.
**ES** should be evapotranspiration surface SWC 0-0.2m

2. same for the `Site` col.
3. same for the `Date` col, and the `Date` col need to be converted.
4. all the rest of cols have this `*`.


**The `*`** means the end of the main table. 

### chop the main table to separate tables 

need a function to figure out which col is not necessary 

```{r Biomass tab}
biomass <- dt[Data == "Biomass"]

col_good <- choose_cols(biomass) # identify the right cols 

biomass <- biomass[,..col_good] # subset the right cols 

```


```{r Root tab}

root <- dt[Data == "Root"]

col_good <- choose_cols(root) # identify the right cols 

root <- root[,..col_good]
```


```{r Phenology tab}

Phenology <- dt[Data == "Phenology"]

col_good <- choose_cols(Phenology) # identify the right cols 

Phenology <- Phenology[,..col_good]
```


```{r Soil water tab}

SoilWater <- dt[Data == "Soil water"]

col_good <- choose_cols(SoilWater) # identify the right cols 

SoilWater <- SoilWater[,..col_good]
```


```{r ES tab}

ES <- dt[Data == "ES"]

col_good <- choose_cols(ES) # identify the right cols 

ES <- ES[,..col_good]
```


### Check again before lock into sqlite

```{r inspect types}
l <- list(biomass, root, Phenology, SoilWater, ES) # put into a list for quick inspection
l %>% 
  lapply(inspect_types)
l %>%
  lapply(colnames)
```

_Note:_

1. variable types are not right
2. `Plant.No....40` is the plant number in the harvest area.
3. `Plant.No....48` is the plant number per $m^2$
4. Phenology tab has biomass cols because missing values as 0s. 
5. The first 11 cols are the factors.
6. Variables in Phenology tab should not be change to numeric. 


```{r fix Phenology tab}
cols_11 <- colnames(dt)[1:11] # the master cols
cols_both <- colnames(Phenology)[colnames(Phenology) %in% colnames(biomass)] # the cols in both tabs
cols_inPheno <- colnames(Phenology)[cols_both %in% cols_11]
Phenology <- Phenology[,..cols_inPheno]
colnames(Phenology)
```


```{r fix the types}

#biomass tab

cols <- colnames(biomass)[!colnames(biomass) %in% cols_11] # the cols need to be converted 
biomass <- biomass[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
#root tab 

cols <- colnames(root)[!colnames(root) %in% cols_11] # the cols need to be converted 
root <- root[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
#soilwater tab

cols <- colnames(SoilWater)[!colnames(SoilWater) %in% cols_11] # the cols need to be converted 
SoilWater <- SoilWater[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]
#es tab

cols <- colnames(ES)[!colnames(ES) %in% cols_11] # the cols need to be converted 
ES <- ES[, (cols) := lapply(.SD, as.numeric), .SDcols = cols]

```

_Note:_ 
There two cols has values been converted to NA by coercion. cautions going forward!!!


**Rerun** the chunck `inspect types`. everything seems awesome 


### Weather data 

What are the key dates to source the right climate data?

Dates|Event
----|----
21-Oct-10 | Sowing Date 1 in AD


MORE DATES IN THE `sqlite` file. 

There are quite a few `.met` files. 


```{r read mets}

Iversen12 <- fread("../Data/Lucerne/lincoln.met", skip = 8)
Iversen12_col <- fread("../Data/Lucerne/lincoln.met", skip = 6, nrows = 1)
colnames(Iversen12) <- colnames(Iversen12_col)
head(Iversen12)

AshleyDene <- fread("../Data/Lucerne/Weather_AshleyDene.met", skip = 10)
AshleyDene_col <- fread("../Data/Lucerne/Weather_AshleyDene.met", skip = 8, nrows = 1)
colnames(AshleyDene) <- colnames(AshleyDene_col)


```


### Lock tabs into sqlite 

```{r sqlite}

con <- dbConnect(SQLite(), "../Data/Richard.sqlite3")
DBI::dbListTables(con)
# The sowing date tab first

colnames(dt_SD_lookup)
# dbExecute(con," CREATE TABLE `SowingDate` (
#   `V120` TEXT NOT NULL,
#   `AD` TEXT NOT NULL,
#   `I12` TEXT NOT NULL,
#   PRIMARY KEY (V120)
# );
# ")

# dbWriteTable(con, "SowingDate", dt_SD_lookup, append = TRUE)# comment out once appended

# the rest 
# sqlite does not support ISO date. it will be julian date. 

# ls()
tab_names <- c("biomass",  "root", "Phenology","SoilWater","ES") 
# purrr::map2(list(biomass, root, Phenology, SoilWater, ES), tab_names, ~ dbWriteTable(con, .y, .x))
# dbWriteTable(con, "met_Iversen12", Iversen12)
# dbWriteTable(con, "met_AshleyDene", AshleyDene)

DBI::dbDisconnect(con)
```




# Attempt to organise all excel dataset into one

```{r}
# read all excels into a list 
l <- lapply(xlsxs, function(x){
  read_excel(file.path(path_apX, x))
})

# name each element as the excel file name
names(l) <- gsub("\\.xlsx", "", xlsxs)
names(l)

# dimension of each excel file
lapply(l, dim) 

# check which dataset has `SW` OR `SWC` in the variable names

no_SW <- lapply(l, function(x){
  vars <- colnames(x)
  sum(grepl( pattern = "SW", x = vars, ignore.case = TRUE, perl = TRUE))
})
```

