---
title: "Data_acquisition"
author: "jian (AKA Frank) liu"
date: "04/10/2019"
output: html_document
---

```{r setup, include=FALSE,warning=FALSE}
knitr::opts_chunk$set(echo = FALSE)
source("../R/packages.R")
source("../R/functions.R")
```


## Import data from apsimx

* All phenotype data are stored in `Excel` files on [the apsimx github account](https://github.com/APSIMInitiative/ApsimX/tree/master/Prototypes/Lucerne).

* All weather files are in the `.met` format and also available on github.

* Soil data and N content of crop component data are mixed in the `Excel` files, which may require sub-setting. 

* A copy of Richard's data (plant, soil moisture and weather) are in the local hard drive. 

**Plan**

1. clone the repo to local 
   _path:_  "C:/Data/latest_apsimx/ApsimX/Prototypes/Lucerne"
2. read necessary Excel files
3. tidy up 
4. join up
5. store in SQLite


### Browser the data folder

```{r browser the data folder}
path_apX = "../Data/Lucerne/"
xlsxs = list.files(path_apX, pattern = "^\\w.+\\.xlsx")
xlsxs
```

_Note_

Need to explore what data inside these `Excel` files


```{r try out new pkg and exam file 1}
exam_xlsxs(path_apX, xlsxs[1])
```

File `r file.path(path_apX, xlsxs[1])` has the expts done in Lincoln. 


```{r exam file 2}
exam_xlsxs(path_apX, xlsxs[2])
```

File `r file.path(path_apX, xlsxs[2])` is from **Argentina**. Seems only the data from `Elliot` has water relative information with total number of obs at 26. 

```{r exam file 3}
exam_xlsxs(path_apX, xlsxs[3])

```

File `r file.path(path_apX, xlsxs[3])` is from **AshleyDene**. Must be the Richard data. 

```{r exam file 4}
exam_xlsxs(path_apX, xlsxs[4])

```

File `r file.path(path_apX, xlsxs[4])` probably is not immediately useful. 


```{r exam file 5}
exam_xlsxs(path_apX, xlsxs[5])

```

File `r file.path(path_apX, xlsxs[5])` could be a validation set???


```{r exam file 6}
# exam_xlsxs(path_apX, xlsxs[6])

```

File `r file.path(path_apX, xlsxs[6])` has data from lincoln, ashleydene and other places over a few years period. need more metadata if want to use this one for any purpose. 


```{r exam file 7}
exam_xlsxs(path_apX, xlsxs[7])

```

File `r file.path(path_apX, xlsxs[7])` seems a duplicated version of last file. Is `Total_SW` for total soil water?? 



```{r exam file 8}
exam_xlsxs(path_apX, xlsxs[8])

```

File `r file.path(path_apX, xlsxs[8])` is not immediately useful. 



File `r file.path(path_apX, xlsxs[9]) ` & `r file.path(path_apX, xlsxs[10])` are duplicated?? need to confirm with Xiumei. 

```{r exam file 11}
exam_xlsxs(path_apX, xlsxs[11])

```

File `r file.path(path_apX, xlsxs[11])` is not immediately useful. 

```{r exam file 12}
exam_xlsxs(path_apX, xlsxs[12])

```

File `r file.path(path_apX, xlsxs[12])` is not immediately useful. 


_Note_

1. Need metadata for variable names 
2. Trial design and data collection method
3. Soil information for water expts
4. Extract all water relevant data and integrate together? 


```{r}
l <- lapply(xlsxs[-c(6,9,10)], function(x){
  exam_xlsxs(path_apX, x)
  
})
names(l) <- xlsxs[-c(6,9,10)]
potentials <- rbindlist(l, idcol = "id")
potentials <- potentials[, water := stringr::str_extract(string = tolower(value), "water|irr|dry|ashley")][!is.na(water)]

```
total number of obs is `r sum(potentials$cnt)`

## Richard data set

```{r richard}
path_richard = "../Data/APSIM_Sim_allobs.txt"
# file_richard = read_excel(path_richard,
#                           skip = 9, 
#                           col_types = c("text","text","date","text","text",
#                                         rep("numeric", 117)))
# inspect_cat(file_richard)
dt = fread(path_richard, skip = 9, na.strings = c("","NA"), select = 1:118)
dt = dt[-nrow(dt), ]#excluded the * 
dt = dt[, Date := dmy(Date)]


dt_SD_lookup = fread(path_richard, skip = 9, na.strings = c("","NA"), select = 120:122)
dt_SD_lookup = dt_SD_lookup[!is.na(AD)]
```

what **S AND E** MEANS? SOWING AND EMERGE?
Alpha|	Growth Stage|		No.
 ---|---|---
S|	Sowing	|	1
E	|Emergence	|	3
J	|Juvenile	|	4
Fi|	Visible Bud	|	5
Fl | Flower Open	|	6


_Note_
Richard excel file has mix variable types. `read_excel` has trouble to deal with it. try python's pandas
_Solution_ manually save it to `.txt`, `fread` can handle the type of variables 


### inspect the data

```{r main table}
colnames(dt)

```

_couldn't use `inspect_cat` because of duplicated colnames?_
There are two `Plant No.` variables.
One is the harvest area plant number and the other one is the plant number per $m^2$

there are multiply tables in one sheet. 
need to separate into different tables 

look at the factor columns only 

```{r main table col}
sapply(dt[,1:11], unique)
```


_Note_ 
1. Need to figure out what `ES` and `*` stands for.
2. same for the `Site` col.
3. same for the `Date` col, and the `Date` col need to be converted.
4. all the rest of cols have this `*`.


**The `*`** means the end of the main table. 


























