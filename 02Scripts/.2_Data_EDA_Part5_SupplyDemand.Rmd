---
title: "kl estimation "
author: "jian (AKA Frank) liu"
date: "`r Sys.Date()`"
output: html_document
---

# Aim

Reproduce a supply and demand to PAWC graph that is similar to this paper

Robertson, M. J., & Fukai, S. (1994). Comparison of water extraction models for grain sorghum under continuous soil drying. Field Crops Research, 36(2), 145â€“160. https://doi.org/10.1016/0378-4290(94)90063-9


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 10, fig.height = 7, dpi = 300)
#Constants
outlier.colour = "#ff0000"
source("R/packages.R")
source("R/functions.R")
```

X AXIS = plant avaiable water content - available in the data set already
Y AXIS = potential evapourtransipiration - need to calculate from supply and demand 

supply and demand change daily. 
so need to get the slurp working properly. 

need to get the LAI and LI line up. 

```{r}
water = read_dbtab("../03processed-data/Richard.sqlite3")
water
weather = read_dbtab("../03processed-data/Richard.sqlite3", table = "met_AshleyDene")
# dbListTables(dbConnect(SQLite(), "../03processed-data/Richard.sqlite3"))
weather

```



```{r, fig.height=7,fig.width=10}
bestfitlayerkls_pred_SW_AshleyDene_SD1[, Source:=basename(Source)]
cf = 2300/max(bestfitlayerkls_pred_SW_AshleyDene_SD1$PSWC)
col_pred = "PSWC"
palette = rep("black", times = 3)
palette_named = setNames(palette,  c("PSWC", "RootDepth","SWC"))
palette_named[2:3] = c("blue", "red")

bestfitlayerkls_pred_SW_AshleyDene_SD1 %>% 
  ggplot(aes(Date, PSWC, color = "PSWC")) +
  geom_line(size = 1) +
  geom_point(data = obs_ADSD1, aes(x = Clock.Today, y = SWC, color = "SWC")) +
  theme_water() +
  scale_x_date(date_labels = "%Y %b", date_breaks = "8 weeks") +
  geom_point(aes(y=RootDepth/cf, color="RootDepth"))+
  scale_y_continuous(limits = range(bestfitlayerkls_pred_SW_AshleyDene_SD1$PSWC), 
                     sec.axis = sec_axis(~ . *cf, name = "Root Depth")) +
  theme(legend.position = c(0.1,0.1)) +
  scale_color_manual(values = palette_named)
```
```{r fig.height=20}
pred = bestfitlayerkls_pred_SW_AshleyDene_SD1 %>% 
  melt(value.name = "pred_VWC",
       measure.vars = readd(value_vars), 
       variable.name = "Depth",
       variable.factor = FALSE)

obs = obs_sw_ADSD1 %>% 
  melt(value.name = "obs_VWC",
       measure.vars = readd(value_vars), 
       variable.name = "Depth",
       variable.factor = FALSE)
dt=merge(pred,obs, by.x = c("Date", "Experiment", "SowingDate","Depth"),
                     by.y = c("Clock.Today","Experiment", "SowingDate", "Depth"),
                     all.x = TRUE)
dt[, Depth := forcats::fct_relevel(as.factor(Depth), paste0("SW(",1:22, ")"))]
point_size = 1
col_pred = "pred_VWC"
palette = rep("black", times = 2)
palette_named = setNames(palette,  c("pred_VWC", "obs_VWC"))
palette_named[2] = c("red")
dt %>% 
  ggplot(aes(Date)) +
        geom_point(aes(y = pred_VWC,  color = "pred_VWC"), size = point_size) +
        geom_point(aes(y = obs_VWC, color = "obs_VWC" ), size = point_size) +
        facet_grid( reformulate( ".", "Depth")) +
        ggtitle(paste0(unique(pred$Experiment), unique(pred$SowingDate))) +
        scale_x_date(date_labels = "%Y %b", date_breaks = "4 weeks") +
        scale_color_manual(name = "", values = palette_named) +
        theme_water() +
        theme(legend.position = "top",
              axis.text.x = element_text(angle = 30, hjust = 1))
```


```{r, fig.height=10,fig.width=15}
bestfitlayerkls_pred_SW_AshleyDene_SD1[, Source:=basename(Source)]
p1 = bestfitlayerkls_pred_SW_AshleyDene_SD1 %>% 
  ggplot(aes(Date, PSWC)) +
  geom_point() +
  theme_water()
p2 = bestfitlayerkls_pred_SW_AshleyDene_SD1 %>% 
  ggplot(aes(Date)) +
  geom_point(aes(y = RootDepth), shape = "|") +
  theme_water()
cowplot::plot_grid(p1 + 
                     theme(axis.text.x.bottom = element_blank(),
                           axis.title.x.bottom = element_blank()), NULL, p2, 
                   align = "v")
pred = bestfitlayerkls_pred_SW_AshleyDene_SD1 %>% 
  melt(value.name = "pred_VWC",
       measure.vars = readd(value_vars), 
       variable.name = "Depth",
       variable.factor = FALSE)
pred[, Depth := forcats::fct_relevel(as.factor(Depth), paste0("SW(",1:22, ")"))]
point_size = 0.5
col_pred = "pred_VWC"
# palette = rep("grey", times = 2)
# palette_named = setNames(palette,  c(col_pred, col_obs))
# palette_named[2] = "red"
p3 = pred %>% 
  ggplot(aes(Date)) +
        geom_point(aes(y = get(col_pred)), size = point_size) +
        
        facet_grid( reformulate( ".", "Depth")) +
        ggtitle(paste0(unique(pred$Experiment), unique(pred$SowingDate))) +
        scale_x_date(date_labels = "%Y %b", date_breaks = "4 weeks") +
        # scale_color_manual(name = "", values = palette_named) +
        theme_water() +
        theme(legend.position = "top",
              axis.text.x = element_text(angle = 30, hjust = 1))
p4 = cowplot::plot_grid(p1 + 
                          theme(axis.text.x.bottom = element_blank(),
                                axis.title.x.bottom = element_blank()), NULL, p2, 
                   align = "v")
cowplot::plot_grid(p4, NULL, p3, nrow = 1, rel_widths = c(2,-1,1))

```


```{r, fig.height=10,fig.width=10}
p1 = pred_swc_SD2[SimulationID == 1] %>% 
  ggplot(aes(Date, PSWC)) +
  geom_point() +
  # geom_point(aes(y = RootDepth), shape = "|") + 
  facet_wrap(~ SimulationID)
p2 = pred_swc_SD2[SimulationID == 1] %>% 
  ggplot(aes(Date)) +
  geom_point(aes(y = RootDepth), shape = "|")
library(gtable)
library(grid) # low-level grid functions are required
g1 <- ggplotGrob(p1)
# g1 <- gtable_add_cols(g1, unit(0,"mm")) # add a column for missing legend
g2 <- ggplotGrob(p2)
g <- rbind(g1, g2, size="first") # stack the two plots
g$widths <- unit.pmax(g1$widths, g2$widths) # use the largest widths
# center the legend vertically
g$layout[grepl("guide", g$layout$name),c("t","b")] <- c(1,nrow(g))
grid.newpage()
grid.draw(g)
print(g)
```