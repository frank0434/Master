---
title: "Data_EDA"
author: "jian (AKA Frank) liu"
date: "04/10/2019"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 3
---

### Expt details 

a. **2** years expt.
b. **2** sites
   a. Lincoln Uni
   b. Ashely Dene
c. **10** sowing date in both sites. 
   a. five sowing date in the first year
   b. five sowing date in second year
   
|Year 1 (Seedling crop) | Year 2 (Seedling & Regrowth)|
|--------| ------------|
|SD1, SD2, SD3, SD4, SD5| The first five sowing date Regrowth|
||SD6, SD7, SD8, SD9, SD10|
_Note:_ The setup helps to compare the seedling and regrowth in the same conditions in Year 2. 

d. **1** cultivar.
e. **4** reps each site. 
f. **2** soil types
   a. stone free - plant available water capaciy (PAWC) 360mm/2.3m
   b. ~~stony - PAWC 240/2.3m~~ This type is for a grazing trial. probably not a good idea for a starting?
   c. very stony 130mm/2.3m 
g. **22** layers of soil water measurements - 10 cm interval below top 20 cm
   a. top 20 cm was measured by TDR. 
   c. remaining 21 layers was meastured by Neutron probe
h. **1** follow treat in both sites - absolute soil evaporation 


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
source("R/packages.R")
source("R/functions.R")
con <- dbConnect(SQLite(), "../03processed-data/Richard.sqlite3")
dbListTables(con)
SowingDates <- dbReadTable(con, "SowingDates") %>% 
  as.data.table()

```

|		  |AD        | I12|
|:----|:-----|:------|
|SD1	|21-Oct-10|	4-Oct-10|
|SD2	|9-Nov-10|	4-Nov-10|
|SD3	|8-Dec-10|	2-Dec-10|
|SD4	|13-Jan-11	|10-Jan-11|
|SD5	|3-Feb-11|	7-Feb-11|
|SD6	|10-Oct-11	|10-Oct-11|
|SD7	|7-Nov-11|	7-Nov-11|
|SD8	|9-Dec-11|	9-Dec-11|
|SD9	|10-Jan-12	|10-Jan-12|
|SD10|	17-Feb-12	|17-Feb-12|


## 20200426 Start to figure out the DUL LL and initial water for different SD

Key outcomes:   
a set of DUL  
a set of LL  
Initial soil water content   
a set of kls   

```{r}
water <- dbReadTable(con, "SoilWater", check.names = FALSE) %>% 
  as.data.table()

water[, ':='(Clock.Today = as.Date(Clock.Today),
             SowingDate = as.factor(SowingDate))
      ][, SowingDate := factor(SowingDate, levels(SowingDate)[c(1,3:10, 2)])]

# Isolate SD 1 in AshleyDene
water[Experiment == "AshleyDene" & SowingDate == "SD1"] %>% 
  ggplot(aes(Clock.Today, SWC, group = Clock.Today)) +
  geom_point()+
  geom_boxplot()


```

**Task1:**  
Grab DUL & LL from each layer. 

```{r, fig.height=40,fig.width=20}
swcTovwc <- 100
ADSD1 <- copy(water)[Experiment == "AshleyDene" & SowingDate== "SD1"][, SWC:=NULL]
ADSD1
id_vars <- colnames(ADSD1)[!colnames(ADSD1) %in% grep("SW\\(\\d.+", colnames(ADSD1), value = TRUE)]
value_vars <- colnames(ADSD1)[!colnames(ADSD1) %in% id_vars]
id_vars
max_min <- function(x){list(DUL = max(x, na.rm = TRUE),
                            LL = min(x, na.rm = TRUE))}

p <- ADSD1 %>% 
  melt(id_vars) %>% 
  .[, variable := fct_relevel(variable, paste0("SW(",1:23, ")"))] %>%
  ggplot(aes(Clock.Today, value, group = Clock.Today)) +
  geom_boxplot() +
  facet_grid( variable~.)
ADSD1[, lapply(.SD, mean),
      by = .(Experiment, Clock.Today, SowingDate), .SDcol = value_vars
      ][, as.list(unlist(lapply(.SD, max_min))),
      by = .(Experiment, SowingDate), .SDcol = value_vars]

```

## 20200511 RESUME the tasks

all DUL_LL for both sites 
PAWC for different sowing dates 

```{r}


# set key and make it order by dates and sowing date
setkey(water, Experiment, SowingDate, Clock.Today)
# water[, SWC:= NULL]
id_vars <- c("Experiment", "Clock.Today", "SowingDate")
value_vars <- grep("SW\\(\\d.+", colnames(water), value = TRUE)
# the range of all valus 
# 
allSD_SWC <- water[, lapply(.SD, mean, na.rm = TRUE), by = id_vars, .SDcols = "SWC" # average 4 reps
                   ][, unlist(lapply(.SD, max_min), recursive = FALSE),
                     by = .(Experiment, SowingDate),.SDcols = "SWC"
                     ][, mean(SWC.DUL) , by = .(Experiment) ]
```
all sowing dates averaged: `r allSD_SWC` 

what if for only the first 5
max SWC and min SWC for the first 5 SD are identical to all SD
but larger than averaged by SD first and then extract MAX AND MIN. 
**USE all SD to extract DUL and LL would be appropriate **
```{r}
water[, lapply(.SD, mean, na.rm = TRUE), by = .(Experiment, Clock.Today), .SDcols = "SWC" # average 4 reps
                   ][, unlist(lapply(.SD, max_min), recursive = FALSE), by = .(Experiment), .SDcols = "SWC"
                     ][, PAWC := SWC.DUL - SWC.LL][]

```
sampling dates does not effect the PAWC because it calculated from MAX(SWC) - MIN(SWC)
A slight different results compare to Richard's 

DUL and LL should be consistant for all sowing dates since they are soil parameters 
Therefore, simply average to have the DUL and LL for each layer will be sufficient at this stage 

```{r}
DUL_LL <- water[SowingDate %in% paste0("SD", 1:5)
                ][, lapply(.SD, mean, na.rm = TRUE), by = .(Experiment, Clock.Today), .SDcols = value_vars # average 4 reps
                  ][, unlist(lapply(.SD, max_min), recursive = FALSE), by = .(Experiment), .SDcols = value_vars]

DUL_LL <- DUL_LL %>% 
  melt(id.var = "Experiment") %>% 
  .[, (c("Depth", "variables")) := tstrsplit(variable, "\\.")] %>% 
  dcast(Experiment +  Depth ~ variables)
DUL_LL[, sum(DUL), by = .(Experiment)]
DUL_LL[, ':='(DUL = DUL / 100,
              LL = LL / 100)][]
```


## 20200509 RESUME the tasks


```{r}
# convert SWC back to VWC
# Layer 1 SW(1) is 20 cm while other layers are 10 cm 
VWC_summarised <- water[, (value_vars) := lapply(.SD, function(x) x/100), .SDcols = value_vars
                        ][, `SW(1)`:= `SW(1)`/2   # top 20 cm is a whole body
                          ][, lapply(.SD, mean, na.rm = TRUE), by = id_vars, .SDcols = value_vars # average 4 reps
                            ][, unlist(lapply(.SD, max_min), recursive = FALSE),
                              by = .(Experiment, SowingDate),.SDcols = value_vars]

VWC_summarised[order(`SW(1).DUL`)]
test <- VWC_summarised[, lapply(.SD, mean, na.rm = TRUE), by = .(Experiment), .SDcols = colnames(VWC_summarised)[-(1:2)]]
# test if the soil profil is right 
test <- test %>% 
  melt(id.vars = "Experiment") %>% 
  .[, (c("Depth", "variables")) := tstrsplit(variable, "\\.")] %>% 
  dcast(Experiment +  Depth ~ variables) 
test[, PAWC := DUL - LL][, sum(PAWC)*2.3*100, by = .(Experiment)]
summary(VWC_summarised[1:10,])
```



```{r}

nested_water <- water[, list(SWC_list = list(.SD)), by = .(Experiment, SowingDate)]
nested_water$SWC_DUL_LL <- lapply(nested_water$SWC_list, function(x){
  x <- x[, lapply(.SD, mean), # average 4 reps for each sowing date
         by = .(Clock.Today), 
         .SDcol = value_vars
         ][, as.list(unlist(lapply(.SD, max_min))), # grap the max and min over two years 
           .SDcol = value_vars]
  x <- melt(x, variable.factor = FALSE, measure = patterns("^SW"))
  })

DUL_LL <- nested_water[,.(Experiment, SowingDate, SWC_DUL_LL)
                       ][, unlist(SWC_DUL_LL, recursive = FALSE),
                         by = .(Experiment, SowingDate)]
range(DUL_LL$DUL)
DUL_LL <- DUL_LL[, (c("Depth", "variables")) := tstrsplit(variable, "\\.")] %>% 
  dcast(Experiment + SowingDate + Depth ~ variables)

# check if all duls > lls, yes if return 0
sum(DUL_LL$LL > DUL_LL$DUL)

SD_PAWC <- DUL_LL[, PAWC := DUL - LL][]

SD_PAWC[, list(PAWC_profile = sum(PAWC, na.rm = TRUE)*2.3*100), by = .(Experiment, SowingDate)
        ][, mean(PAWC_profile) , .(Experiment) ]

SD_PAWC <- DUL_LL %>% 
  dcast(Experiment + SowingDate  ~ Depth, value.var = "PAWC")
SD_PAWC[, PAWC := rowSums(.SD, na.rm = T), .SDcols = value_vars][,.(Experiment, SowingDate, PAWC)]

SD_PAWC[, Depth:= fct_relevel(as.factor(Depth), paste0("SW(", 1:22,")"))] %>% 
  ggplot(aes(x = SowingDates)) +
    geom_point(aes(y = DUL))+
  facet_grid(~ Depth)
```
initial soil water = the soil water contents at the sowing date
need to be percentage of the full PAWC?

```{r, fig.width=8, fig.height=12}

SWC_MEAN <- water[,.(Experiment, Clock.Today, SowingDate, SWC)
      ][, .(mean_swc = mean(SWC, na.rm = TRUE)), by = .(Experiment, SowingDate, Clock.Today)]
SWC_MEAN[Experiment == "AshleyDene"
         ][, SowingDate := fct_relevel(as.factor(SowingDate), paste0("SD", 1:10))]%>% 
  ggplot(aes(Clock.Today, mean_swc)) +
  geom_point() +
  facet_grid( SowingDate ~ Experiment,scales = "free_y") +
  geom_hline(aes(yintercept = min(SWC_MEAN[Experiment == "AshleyDene"]$mean_swc)), color = "red")+
  geom_hline(aes(yintercept = max(SWC_MEAN[Experiment == "AshleyDene"]$mean_swc)), color = "blue") + 
  theme(text = element_text(size = 14))
ggsave("../05figures/SoilWaterEDA/AverageSWC_AD.pdf", height = 12, width = 8, dpi = 300)
SD <- SowingDates[, (c("AD", "I12")) := lapply(.SD, as.Date), .SDcols = c("AD", "I12")] %>% 
  melt(id.vars = "SD", 
       variable.name = "Experiment", value.name = "Clock.Today",
       variable.factor = FALSE) 
SD[, Experiment := ifelse(Experiment == "AD", "AshleyDene",  "Iversen12")]
water[SD, on = c("Experiment", "SowingDate == SD", "Clock.Today"), roll = "nearest"][Clock.Today == "2010-11-09"]
```

SD1 in Ashley Dene has no SWC measurements. 
Use the value from nearest measruement date instead, which was 2010-11-09

[Initial Soil Water](https://www.apsim.info/documentation/model-documentation/soil-modules-documentation/soilwat/)

There are five ways to parameterise initial soil water in SoilWater.  
These can also be specified in the Manager module sections using the ‘set’ command  
e.g SoilWater set insoil = 0.5 ()  




## inspect all sowing dates for vwc


```{r}
AD_long <- water[,SWC:=NULL] %>% 
  melt(id_vars)
# check levels
levels(AD_long$variable)
# check if the plot still the same 
# AD_long[SowingDate == "SD1" & Experiment == "AshleyDene"] %>% 
#   ggplot(aes(Clock.Today, value)) +
#   geom_boxplot()  +
#   facet_grid(variable ~ .)
# place data into a nested dt 
nested <- AD_long[, list(dt_list=list(.SD)), by = .(Experiment,SowingDate)]

device = "pdf"

pmap(list(nested$Experiment, nested$SowingDate, nested$dt_list), 
     
     ~ggsave(filename = file.path("../05figures/SoilWaterEDA", paste0("SD_water",..1, ..2, ".",device)),
             plot = ggplot(..3, aes(Clock.Today, value))+
               geom_boxplot()+
               ggtitle(paste0(..1, ..2)) +
               facet_grid( variable~., scales = "free_y"),
             device = device,dpi = 300, height = 30, width = 15)
      )
```

_Note_  
1. SD2 in AD seems have a consistant outliner rep in the top 40 cm soil.   
2. SD7 in AD seems have a consistant outliner rep in BETWEEN 40 and 100 cm soil.   
3. I12 had one rep that had some outliner through the second season in the subsoil between 110 ~ 140 cm.  

_Question_   
1. How to deal with the outliners? just average them out?  
2. Identify them?   


```{r try average first}
DT <- nested[, dt_list := lapply(dt_list, function(x){
  x[,.(value = mean(value, na.rm = TRUE)/100),
    by = .(Clock.Today, variable)
    ]
  })] # average the swc value among reps and change to vwc
DUL_LL <- copy(DT)[, dt_list := lapply(dt_list, function(x){
  x[, .(min = min(value, na.rm = TRUE),
        max = max(value, na.rm = TRUE)),
    by = .(variable)]
  }) # figure out the DUL and LL for each layer
  ][, unlist(dt_list, recursive = FALSE), 
    by = .(Experiment,SowingDate)] # unnest the data.table

```



## 20200330 Grab above ground component and soil water 

Unit conversion for visulising the graph in apsimx UI.   

```{r}
path_richard = "c:/Users/cflfcl/Dropbox/Data/APSIM_Sim.xlsx"
con <- dbConnect(SQLite(), "../03processed-data/Richard.sqlite3")
dbListTables(con)
biomass <- dbReadTable(con, "biomass") %>% 
  as.data.table()
water <- dbReadTable(con, "SoilWater", check.names = FALSE) %>% 
  as.data.table()
dbDisconnect(con)

# Fix the date 
biomass[, Clock.Today := as.Date(Clock.Today)]
water[, Clock.Today := as.Date(Clock.Today)]


# Bring in the meta data for calculation 
meta_data <- read_excel(path_richard)
# Dry matter value to evaluate the apsimx predict value 
# Need to be in g/m2 unit
DM_obs <- meta_data %>% 
  filter(!is.na(Equations)) %>% 
  mutate(Equations = gsub("\\s|\\(|\\)",".", Equations))
```

#### Look at the plot level - EDA

```{r fig.height=22, fig.width=10}
AD <- water[Experiment == "AshleyDene"]

# AD[, SWC := NULL] # drop it for now
setorder(AD, "SowingDate","Plot") # Sort it by Plot

# Grab the key vars for melting down to long format
id_vars <- colnames(AD)[!colnames(AD) %in% grep("SW", colnames(AD), value = TRUE)]

# Filter down to only sowing date 5 and do a trial plotting 
AD[SowingDate == "SD5" ] %>% 
  melt(., id.vars = id_vars) %>% 
  ggplot(aes(Clock.Today, value)) + 
  geom_point() +
  facet_grid(variable ~ Plot)

# Iterate all sowing date to output the graph
var_sd <-  AD$SowingDate %>% unique()
dir <-  "SoilWater"
dir_EDA <- file.path("..", "05figures", paste0(dir,"EDA"))
dir_exits <- dir.exists(dir_EDA)
if(!dir_exits){
  dir.create(dir_EDA)
}
# Depth ~ Plot in Sowing Date 
lapply(var_sd, function(x){
  p <- AD[SowingDate == x ] %>% 
    melt(., id.vars = id_vars) %>% 
    ggplot(aes(Clock.Today, value)) + 
    geom_point() +
    facet_grid(variable ~ Rep, scales = "free_y") +
    ggtitle(x)
  # ggsave(filename = paste0(dir_EDA, "/",x, ".pdf"), plot = p, device = "pdf", width = 10, height = 22, dpi = 300)

})

# Sowing date 1 to 5, investigate variations among reps
p <- AD[SowingDate %in% paste0("SD", 1:5)] %>% 
  melt(., id.vars = id_vars) %>% 
  ggplot(aes(Clock.Today, value, color = as.factor(Rep))) + 
  geom_point() +
  facet_grid(variable ~ SowingDate, scales = "free_y") 


# ggsave(filename = paste0(dir_EDA, "/SD1To5.pdf"), plot = p, device = "pdf", width = 10, height = 44, dpi = 300)

p <- AD[SowingDate %in% paste0("SD", 6:10)] %>% 
  melt(., id.vars = id_vars) %>% 
  ggplot(aes(Clock.Today, value, color = as.factor(Rep))) + 
  geom_point() +
  facet_grid(variable ~ SowingDate, scales = "free_y") 


# ggsave(filename = paste0(dir_EDA, "/SD6To10.pdf"), plot = p, device = "pdf", width = 10, height = 44, dpi = 300)

```


#### Read sql from replicates prediction

```{r}
con <- dbConnect(SQLite(), "../01raw-data/ApsimxFiles/PlotByPlot.db")
dbListTables(con)
Report <- dbReadTable(con, "Report", check.names = FALSE) %>% 
  as.data.table()
Report[, Clock.Today := as.Date(Clock.Today)]
dbDisconnect(con)
```
Probably not very useful since all the Rep will use the same set of soil parameters 


```{r}
dim(Report)

id_vars <- colnames(Report)[1:4]
value_vars <- colnames(Report)[colnames(Report) %in% grep("SW", colnames(Report), value = TRUE)]
new_cols <- c(id_vars,value_vars)
p <- Report[,..new_cols][, SWC := NULL][SowingDate %in% paste0("SD", 1:5)] %>% 
  melt(., id.vars = id_vars) %>% 
  .[, value := round(as.numeric(value))] %>% 
  ggplot(aes(Clock.Today, value, color = as.factor(Zone))) + 
  geom_point() +
  facet_grid(variable ~ SowingDate) 


ggsave(filename = paste0(dir_EDA, "/PredictSD1To5.pdf"), plot = p, device = "pdf", width = 10, height = 44, dpi = 300)

```




### Import data from sqlite

```{r import sqlite}
con <- dbConnect(SQLite(), "../Data/Richard.sqlite3")
soilwater <- dbReadTable(con, "SoilWater")
biomass <- dbReadTable(con, "biomass")
root <- dbReadTable(con, "root")
ES <- dbReadTable(con, "ES")
dbDisconnect(con)

#fix date

soilwater <- fix_date(soilwater)
biomass <- fix_date(biomass)
root <- fix_date(root)
ES <- fix_date(ES)
```


### Soil Water Overview 

_Note:_

`SWC.2.3.m..mm.` is the profile water for each ob?
Need to fix the layer names

**The soil water has `r dim(soilwater)[1]` obs. **


```{r Plot, fig.height=15, fig.width=10,dpi=300}
vars <- colnames(soilwater)[c(1:9,33)]
soilwater_melted <- soilwater %>% 
  melt(.,id.vars = vars, variable.factor = FALSE) %>% 
  .[, variable := as.integer(gsub("SWC.0.", "", variable))]
soilwater_melted[, Sowing.Date := fct_relevel(as.factor(Sowing.Date), levels = c(paste0("SD",1:10)))] %>% 
  
  ggplot(aes(Date, value, color = as.factor(variable))) + 
  geom_point() +
  facet_grid(Sowing.Date ~ Site ) +
  theme_water() +
  scale_color_viridis_d()
soilwater_melted[Sowing.Date %in% paste0("SD", 1:5)] %>% 
  ggplot(aes(Date, value, color = Sowing.Date)) + 
  geom_point() +
  facet_grid(variable ~ Site ) +
  theme_water() +
  ggtitle("First 5 sowing date")
```


```{r profile water}
soilwater[,.(Date, Site,Sowing.Date,SWC.2.3.m..mm.) ]%>% 
  ggplot(aes(Date, SWC.2.3.m..mm., color = Sowing.Date)) + 
  geom_point() +
  facet_grid( ~ Site ) +
  theme_water() +
  ggtitle("Profile water")
```



```{r soilwater hist each layer, fig.height=12, fig.width=12, message=FALSE,warning=FALSE,dpi=300}

nums <- inspect_num(soilwater[Site == "AshleyDene"])
show_plot(nums)
print("SWC distribution in each layer in AshleyDene")

nums <- inspect_num(soilwater[Site != "AshleyDene"])
show_plot(nums)
print("SWC distribution in each layer in Lincoln Uni")
```

```{r hist}
soilwater_melted %>% 
  ggplot(aes(value))+
  geom_histogram() +
  facet_grid( ~ Site) +
  theme_water()



```

### Evapotranspiration surface

This is for calibrate the model for Potential Ep since there is no crop growing on this area?


```{r ES, fig.height=14, fig.width=14, dpi=300}

vars <- colnames(ES)[c(1:6,31)]
ES_melted <- ES %>% 
  melt(.,id.vars = vars, variable.factor = FALSE) %>% 
  .[, variable := as.integer(gsub("SWC.0\\.", "", variable))]
ES_melted[, variable:= ifelse(is.na(variable), 24, variable)] %>% 
  ggplot(aes(Date, value)) + 
  geom_point() +
  facet_grid(variable ~ Site ) +
  theme_water()

```

### Biomass Overview 



**The Biomass has `r dim(biomass)[1]` obs for two sites. **




```{r biomass, fig.height=12, fig.width=12, message=FALSE,warning=FALSE,dpi=300}

nums <- inspect_num(biomass)
show_plot(nums)
inspect_cat(biomass) %>% 
  show_plot()
```

```{r}
# GGally::ggpairs(biomass[,.(Site, Sowing.Date, Date, FW..g.,DW..g.)],aes(colour = Site, alpha = 0.4))
colnames(biomass)
biomass_sub <- biomass[,.(Site, Date, Sowing.Date, DAS,  Shoot.No., Shoots.m2, FW..g., DW..g., Leaf.Area..cm.,LAImod)]
```

_Note:_

Too many vars, take long time to generate the pairplot. 
R is a bit slow to plot big correlation plots 
Try seaborn in python. still slow. 
consider to set up `Draker` plan. 



![Biomass random plotting](biomass_cor.png)
**Maybe leave the biomass data at last to touch. **
```{python}
# import seaborn as sns
# import matplotlib.pyplot as plt
# 
# sns.pairplot(r.biomass_sub, hue="Sowing.Date")
# plt.show()
# plt.savefig("biomass_cor.png", dpi = 300)
```



### Root Overview 


**The Root tab has `r dim(root)[1]` obs. **


```{r root, fig.height=12, fig.width=12,dpi=300}

nums <- inspect_num(root)
show_plot(nums)
```


