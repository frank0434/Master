---
title: "Data_integration"
author: "Frank" 
date: "`r sys.Date()`"
output:
  html_document: 
    code_folding: hide
    toc: true
    toc_depth: 3
---

Aim:  

~~1. Integrate all observed data into a excel format so that it can be sourced by apsimx to do graphying.~~

New Aim:   
1. Grep data from cache and visulise it in R for pred vs obs comparsion.  



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
source("R/packages.R")
source("R/functions.R")

```

# New aim  

```{r read cache}
loadd(starts_with("configs"))
configs_AshleyDene_SD3
```

# EAD on other variables 

```{r}
loadd(starts_with("pred"))
cols = grep("SW", colnames(prediction_AshleyDene_SD2), invert = TRUE, value = TRUE)
adsd2 = prediction_AshleyDene_SD2[,..cols]
```

```{r observed}

biomass = read_dbtab("../03processed-data/Richard.sqlite3", "biomass")

cover = fread("../03processed-data/CoverData/CoverDataAshleyDeneSD2.csv")
# LAI was output as raw - no summarise 
LAI = fread("../03processed-data/CoverData/LAIAshleyDeneSD2.csv")
LAI = LAI[, .(LAI = mean(LAImod)), by = .(Clock.Today)]
obs = merge(cover, LAI, by.x = "Date" , by.y = "Clock.Today")
```


```{r}
adsd2_obs = biomass[Seed == "CS" & Harvest.No. != "Post" & 
                      Experiment %like% "Ash" &
                      SowingDate == "SD2", .(Height, Total.DM), 
                    by = .(Experiment, SowingDate, Clock.Today)
                    ][, unlist(list(lapply(.SD, mean, na.rm = TRUE)), 
                               recursive = FALSE), 
                      by = .(Experiment, SowingDate, Clock.Today)
                      ][, Clock.Today := as.character(Clock.Today)]

adsd2_obs = merge(adsd2_obs, obs, 
                  by.y = "Date" , 
                  by.x = "Clock.Today")[, Clock.Today := as.Date(Clock.Today)]
```

```{r}
pred_obs = merge.data.table(adsd2, adsd2_obs, 
                            by.x = c("Date", "Experiment", "SowingDate"),
                            by.y = c("Clock.Today", "Experiment", "SowingDate"),
                            all.x = TRUE)
plot_params(pred_obs, title = "../05figures/ADSD2_LAI", col_pred = "LAI.x", col_obs = "LAI.y", 
            stats = FALSE, group_params = ".", format = "png")
plot_params(pred_obs, title = "../05figures/ADSD2_Height", col_pred = "Height.x", col_obs = "Height.y", 
            stats = FALSE, group_params = ".")

plot_params(pred_obs, title = "../05figures/ADSD2_totalDM",
            col_pred = "AboveGroundBiomass",
            col_obs = "Total.DM", 
            stats = FALSE, group_params = ".")
plot_params(pred_obs, title = "../05figures/ADSD2_totalDM",
            col_pred = "CoverTotal",
            col_obs = "LightInterception", 
            stats = FALSE, group_params = ".")
```


```{r read db for preds}
preds = read_dbtab("../03processed-data/apsimxLucerne/BestfitLayerkl.db", table = "Report")

```
# Build xlsx to use in the UI 

```{r}
loadd(starts_with("SW"))
water = merge.data.table(SW_mean, SWC_mean, by = c("Experiment", "SowingDate", "Clock.Today"))

biomass_obs = biomass[Seed == "CS", .(Height, LAI = LAImod,  Total.DM), 
                    by = .(Experiment, SowingDate, Clock.Today)
                    ][, unlist(list(lapply(.SD, mean, na.rm = TRUE)), 
                               recursive = FALSE), 
                      by = .(Experiment, SowingDate, Clock.Today)
                      ][, Clock.Today := as.Date(Clock.Today)]

biomass_obs = biomass_obs[Clock.Today > "2011-11-30" & 
                            Clock.Today < "2012-03-01" & 
                            Experiment == "AshleyDene", k:= 0.66
                          ][, k := ifelse(is.na(k), 0.94, k)
                            ][, LightInterception := 1 - exp(-k*LAI)]
whole = rbindlist(list(water, biomass_obs), fill = TRUE, use.names = TRUE)

whole[, ':='(SimulationName = paste0(Experiment, "SowingDate", SowingDate))]
setcolorder(whole, "SimulationName")
write.xlsx(whole, "../03processed-data/20200630Whole.xlsx", sheetName = "Observed")

```

# Old aims

```{r}
con <- dbConnect(SQLite(), "../03processed-data/Richard.sqlite3")
dbListTables(con)
biomass <- dbReadTable(con, "biomass") %>% 
  as.data.table()
water <- dbReadTable(con, "SoilWater", check.names = FALSE) %>% 
  as.data.table()
dbDisconnect(con)

# Fix the date 
biomass[, Date := as.Date(Date)]
water[, Date := as.Date(Date)]
```


```{r second attempt}
key_vars <- colnames(biomass)[c(2:7, 24:26)]
group_vars <- c("Site", "Date", "Season", "Sowing.Date")

# No need to convert unit. All DM in apsimNG are kg DM/ha
total_dm <- copy(biomass)[, ..key_vars # select the necessary vars
                          ][, lapply(.SD, function(x) mean(x, na.rm = TRUE)), # calculate the mean
                            .SD = key_vars[7:9],
                            by = group_vars
                            ][Total.DM != 0]

# Get colnames 
value_vars <- grep("SW.+", colnames(water), value = TRUE)
# Calculate the mean over replicates 
water_sum <- copy(water)[, lapply(.SD, function(x) mean(x, na.rm = TRUE)), # calculate the mean 
                         .SD = value_vars, by = group_vars]

# Stack two together
joined <- rbindlist(list(total_dm,water_sum), fill = TRUE)
# Modify in place. Type correction, SimName construction, 0 replace by NAs
joined <- joined[Site == "AshleyDene" # Look at AD only
                 ][, Date := as.Date(Date)
                     ][, SimulationName := paste0(Site, "SowingDate",Sowing.Date)
                       ][, lapply(.SD, function(x){
                         if(is.numeric(x)){
                           x = ifelse(x == 0, NA, x) # if numeric then replace 0 by NA
                           } else {
                             x # necessary one to keep all other type of columns
                             }
                         })]
setnames(joined, c("Date","Total.DM"),c("Clock.Today","ShootWt"))
joined[, ':=' (Site = NULL,
               Sowing.Date = NULL,
               Season = NULL)]
setcolorder(joined, "SimulationName")

```

**The harvest date and soil moisture measurement dates do not match, which is probably the reason that all observed data stack on top of each other that way**


```{r}
joined %>% 
  write.xlsx("../03processed-data/20200330_DM_SWC_sum.xlsx", sheetName = "Observed")
```

```{r }

path_apX <- "../01raw-data/ClimateAndObserved/Lucerne/"
xlsxs <- list.files(path_apX, pattern = "^\\w.+\\.xlsx")
xlsxs
```

```{r }
path <- "C:/Users/cflfcl/Dropbox/ApsimX_Lucerne/"
list.files(path, pattern = ".met")
l <- list.files(path, pattern = ".met", full.names = TRUE)
names(l) <- l
lapply(l, function(x)fread(x, skip = "()",nrows = 30))

```

21 `.met` files 
select the ones needed based on the apsimx output DB

