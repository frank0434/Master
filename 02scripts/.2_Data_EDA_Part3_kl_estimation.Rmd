---
title: "kl estimation "
author: "jian (AKA Frank) liu"
date: "`r Sys.Date()`"
output: html_document
---

# Protocol

- Input data ready: met, cover and slurp `.apsimx`  
- Parameter ready: 
|Parameters|Units |Parameter levels tested |Description|
|:----|:----|:----|:----|
|RFV| mm/day| 10, 15, 20, 25, 30 and 35 |Maximum rate of root extension at 25 °C|
| $kl_{0}$|/day| 0.01, 0.03, 0.05, 0.07,0.09 and 0.11|Maximum kl value at surface layer(s)|
|$\lambda_{kl}$| dimensionless | −0.0005, −0.001,−0.002, −0.003,−0.005 and −0.01 | Exponential decay of kl0 with soil depth|  

- Set constant of key and values 

- Invoke **Edit**  [Invoke Apsimx]  


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center", fig.width = 10, fig.height = 7, dpi = 300)
#Constants
outlier.colour = "#ff0000"
source("R/packages.R")
source("R/functions.R")
con <- dbConnect(SQLite(), "../03processed-data/Richard.sqlite3")
dbListTables(con)
SowingDates <- dbReadTable(con, "SowingDates") %>% 
  as.data.table()

```


```{r subset}
biomass <- dbReadTable(con, "biomass", check.names = FALSE) %>% 
  as.data.table()
biomass[, ':='(Clock.Today = as.Date(Clock.Today))]
dbDisconnect(con)
# set key and make it order by dates and sowing date
setkey(biomass, Experiment, SowingDate, Clock.Today)
id_vars <- key(biomass)

LAI <- biomass[, .(LAImod), by = key(biomass)]
```


# Overview of the LAI
P88 in the thesis, 
LAI was calculated from $Specfic Leaf Area(SLA) \times TotalFW_{HarvestArea} \div 2000 $ 
```{r glimpse}

kable(LAI[1:50, ], caption = "Initial soil biomass content in each layer in 10 sowing dates")%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")

```




```{r graphLAI, fig.height=10}
LAI[, SowingDate := fct_relevel(as.factor(SowingDate), paste0("SD", 1:10))] %>% 
  ggplot(aes(Clock.Today, LAImod, color = SowingDate)) +
  geom_point() +
  geom_hline(yintercept = 1, colour = "#ff0000") +
  facet_grid(SowingDate~ Experiment) +
  theme_water()

LAI_summaried <- LAI[, LAImod := ifelse(LAImod == 0, NA, LAImod) # Some values are 0 which should be NAs
                     ][, list(mean = mean(LAImod, na.rm = TRUE)), by = id_vars
                       ][!is.na(mean)]

LAI_summaried %>% 
  ggplot(aes(Clock.Today, mean, color = SowingDate)) +
  geom_point() +
  geom_hline(yintercept = 1, colour = "#ff0000") +
  facet_grid(SowingDate~ Experiment) +
  theme_water()
# Output the SW for different SDs
sites <- unique(SW_initials$Experiment)

```


# Combine Soil Paras

```{r}
SW_DUL_LL <- SW_initials[DUL_LL_SDsVWC, on = c("Experiment", "SowingDate", "Depth")][Depth != "SW(2)"]

# Check if anything unusual 
SW_DUL_LL[DUL<SW]
SW_DUL_LL[LL>SW]

# Order the layers
SW_DUL_LL[, ':='(Depth = as.integer(gsub("\\D", "", Depth)),
                 SowingDate = fct_relevel(as.factor(SowingDate), paste0("SD", 1:10)))]
# order the order - CRITICAL 
setkey(SW_DUL_LL, Experiment, SowingDate, Depth)
kable(SW_DUL_LL, caption = "Initial soil parameters for 22 layers in 10 different sowing dates.")%>%
  kable_styling() %>%
  scroll_box(width = "100%", height = "500px")
```


# Slurp simulations setup in the .2_Data_EDA_Part2

# Slurp results analysis 

```{r}
con_eda <- dbConnect(SQLite(), "../03processed-data/apsimxFiles/ModifiedSKL_0.01AshleyDeneSD2.db")
dbListTables(con_eda)
report <- dbReadTable(conn = con_eda, "Report",  check.names = FALSE)%>% 
  as.data.table()
dbDisconnect(conn = con_eda)
```
## Subset the preds

```{r}
pred_swc_SD2 <- report[,.(Date = as.Date(Date), SimulationID,KLR, RFV, SKL, k, LAI, PSWC)][order(SimulationID)]
```

## Browse the preds


```{r, fig.height=10,fig.width=10}
pred_swc_SD2 %>% 
  ggplot(aes(Date, PSWC)) +
  geom_point() +
  facet_wrap(~ SimulationID)

```

## Subset the obs 

```{r}
con <- dbConnect(SQLite(), "../03processed-data/Richard.sqlite3")
water <- dbReadTable(con, "SoilWater", check.names = FALSE) %>% 
  as.data.table()
water[, ':='(Clock.Today = as.Date(Clock.Today))]

obs_SD2 <- water[, lapply(.SD, mean, na.rm = TRUE), by = id_vars, .SDcols = "SWC" # average 4 reps
      ][SowingDate == "SD2" & Experiment == "AshleyDene"]
```

## Join the pred and obs

```{r}
# Join and drop NAs of no obs
pred_obs <- pred_swc_SD2[obs_SD2, on = c(  "Date" = "Clock.Today" )][order(SimulationID)]
 # obs_SD2[pred_swc_SD2, on = c(  "Clock.Today" = "Date"), by = "SimulationID"]
# pred_obs[complete.cases(pred_obs)]
NSE(pred_obs$PSWC, pred_obs$SWC)
```

## Stats

```{r}
TEST <- pred_obs[SimulationID == 1]
m <- gof(sim = TEST$PSWC, obs = TEST$SWC) 
m[4] # RMSE
m[5] # Normalised RMSE
m[9] # NSE Nash-Sutcliffe Efficiency ( -Inf <= NSE <= 1 )
m[16] # Pearson Correlation coefficient ( -1 <= r <= 1 )
m[17] # Coefficient of Determination ( 0 <= R2 <= 1 ). 
      # Gives the proportion of the variance of one variable that is predictable from the other variable

setnames(test, rownames(m))
setkey(pred_obs, "Experiment", "SimulationID", "SowingDate", "KLR","RFV","SKL")
nested <- pred_obs[, list(data = list(.SD)), by = key(pred_obs)][]
nested[, data := lapply(data, function(x){
  m <- hydroGOF::gof(x$PSWC, x$SWC)
  m <- m %>% 
    as.data.table(keep.rownames = T) %>% 
    transpose(make.names = 'rn')
})]
nested$data[[1]]


stats <- nested[, unlist(data, recursive = FALSE), by = key(pred_obs)]
stats
```

## visul check 
```{r}
pred_obs %>% 
  ggplot(aes(Date, PSWC)) +
  geom_point() +
  geom_point(aes(y = SWC), color = "red") +
  facet_wrap(~ SimulationID)
  
```

```{r}
dbs <- list.files(path = "../03processed-data/apsimxFiles/", pattern = ".db$", full.names = TRUE)
l_dbs <- lapply(dbs, function(x) {
  con <- dbConnect(RSQLite::SQLite(), x)
  df <- dbReadTable(con, "Report", check.names = FALSE)
  dt <- as.data.table(df)
  })
```



