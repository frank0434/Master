---
title: "APSIM_edit_fun"
author: "Junqi Zhu and Jian Liu"
date: "`r Sys.Date()`"
output: html_document
---

# Protocol

- Load data from sqlite   
- Set constants. e.g. colours and keys  
- Set target  
    Key outcomes:   
    - Initial soil water content[Initial soil water]      
    - A set of DUL[DUL AND LL]  
    - A set of LL[DUL AND LL]  
- Calculation and summarising  
- Joining[Combine Soil Paras]  
- Set up directory structure[Set directory structure]  
- Invoke **Edit**  [Invoke Apsimx]  


```{r setup, include=FALSE}
#  Sys.setenv(R_LIBS_USER  = "H:/Rlibs") 
# .libPaths( c("H:/Rlibs", .libPaths()))
  

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE,
                      fig.align = "center", 
                      fig.width = 10, fig.height = 7, dpi = 300)
#Constants
outlier.colour = "#ff0000"

```



# Set directory structure

```{r}

#path to apsimx 
apsimx = "C:/Data/ApsimX/ApsimXLatest/Bin/Models.exe"
apsimx_flag = "/Edit"
apsimx_file = "C:/Data/Master/01raw-data/ApsimxFiles/20200517BaseSlurp.apsimx"
apsimx_sims_dir = "C:/Data/Master/03processed-data/"
apsimx_config = "C:/Data/Master/03processed-data/Configure_Grape_"
  
# Prepare the configuration file

# ApsimX node paths 

KL_layer = 22

## The site level configuration 
config_weather = "[Weather].FileName = "
config_Height = "[SetCropVariables].Script.MaximumHeight = "
config_BD = "[Soil].Physical.BD = "
## The Sowing date level configuration 

config_SDnode = "[SlurpSowingRule].Script.SowingDate = "
config_ClockStart = "[Clock].Start = "

config_CoverData = "[SetCropVariables].Script.CoverFile = "
config_initialSW = "[Soil].InitialConditions.SW = "

config_DUL = "[Soil].Physical.DUL = "
config_SAT = "[Soil].Physical.SAT = "

config_AirDry = "[Soil].Physical.AirDry = "
config_LL15 = "[Soil].Physical.LL15 = "
config_LL = "[Soil].Physical.SlurpSoil.LL = "

## The kl parameter level configuration 
config_KL = paste0("[Soil].Physical.SlurpSoil.KL", "[1:", KL_layer,"]"," = ")


nodes = grep("config_", x = ls(), value = TRUE)

nodes_v = vector("character", length = length(nodes))

for (i in seq_len(length(nodes))){
  names(nodes_v)[i] = get(nodes[i])
}



par = c(1)

APSIMEditFun = function(par)
{

  # Node Path - copied from ApsimX UI
  klr = "[SlurpSowingRule].Script.KLReductionFactor = "
  rfv = "[SlurpSowingRule].Script.RFV = "

# Vectorise the values 
  # for(i in SDs){
    # Filter the right values 
    apsimx_RUE_JV = paste0(RUE_JV, par)
    # apsimx_RUE_VE = paste0(RUE_VE, par[2])
                         # paste(j,collapse = ","))
    # Open a text file
    f = file(paste0(apsimx_config, "RUE", par, ".txt"), "w")
    # Write values into the file 
    cat(
        apsimx_RUE_JV,"\r",
        # apsimx_RUE_VE,"\r",
        sep = "\r", 
        file = f, 
        append = TRUE)
    # Close the file and clean it from memory 
    close(f)
    rm(f)
    gc()
  
}

APSIMRun = function(par)
{
  # Create a new name for the apsimx file 
  newname = paste0(apsimx_sims_dir, "RUE", par, ".apsimx")
  
  # Copy base apsimx file to its new name 
  system(paste("cp", apsimx_file, newname))
  
  # Modify the apsimx file 
  system(paste(apsimx, newname, apsimx_flag, 
               paste0(apsimx_config,  "RUE", par, ".txt")))
  
  # Execute the new apsimx file 
  system(paste(apsimx, newname, 
                 "/NumberOfProcessors:8"))
    
}

library(RSQLite)
cost.function = function(par)
{
  # Iterate through the parameters 
  for (i in par){
    
    APSIMEditFun(par = i)
    
    APSIMRun(par = i)
  
  gc()
  }
  
  for (i in par){
  

  db = RSQLite::dbConnect(RSQLite::SQLite(),
              paste0(apsimx_sims_dir, "RUE", i, '.db'))
  
  dbListTables(db)
  #dbWriteTable(con, "mtcars", mtcars) #add a table into database
  PredictedObserved =   dbReadTable(db,"PredictedObserved")
  
  shoot.dw = na.omit(PredictedObserved$Observed.shoot.dw - 
                      PredictedObserved$Predicted.shoot.dw)
  
  cost1 = sum(shoot.dw^2)
  
  RSQLite::dbDisconnect(db)
  
  rm(db)
  gc()
  
  # system(paste("rm", paste0(apsimx_sims_dir, "tempGrape*")))
  
  return(cost1)
  }
}

```

KLR RANGE 
0.0005,00.001,00.002,00.003,00.005,000.01 

[SlurpSowingRule].Script.RFV = 10,15,20,25,30,35
#run the optim function
```{r}
t1 = Sys.time()
#DEoptim
maxIt = 1
n = 1

opt.res =
  DEoptim::DEoptim(fn=cost.function, 
                   lower = c(0.8),
                   upper = c(1.3),
                   control=list(NP=1, itermax=maxIt, parallelType=1,
                                storepopfrom = 1,
                                packages = c('RSQLite'),
                                parVar = c(
                                'apsimx',
                                'apsimx_flag',
                                'apsimx_file',
                                
                                'apsimx_sims_dir',
                                'apsimx_config',
                                'APSIMEditFun', 
                                'APSIMRun' ))
  )


save(opt.res, file =  file.path(apsimx_sims_dir,
                                paste0('opt.res', ".RData")))

fit.par = data.frame(estimates = opt.res$optim$bestmem, cost = opt.res$optim$bestval)

 
#output the statistical test
par = fit.par$estimates

write.csv(par, 'opt.par.csv', row.names = F)
t2 = Sys.time()
t2-t1
```


Show in New WindowClear OutputExpand/Collapse Output
Iteration: 1 bestvalit: 139.576077 bestmemit:    0.806773
Time difference of 5.29212 mins

Show in New WindowClear OutputExpand/Collapse Output
Iteration: 1 bestvalit: 139.500441 bestmemit:    0.800606
Time difference of 2.457922 mins






```{r}
plot(opt.res, plot.type = "bestmemit")
plot(opt.res, plot.type = "storepop")
```


































It only takes 6 seconds for the apsimx ui to run 10 simulations. 