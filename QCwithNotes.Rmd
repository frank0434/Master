---
title: "1. Debug targets"
output: 
  html_document:
    toc: true
    toc_depth: 2 
    code_folding: hide
---

```{r setup, include=FALSE}
source("02Scripts/R/packages.R")
source("02Scripts/R/functions.R")
library(targets)
```

```{r}
tar_load(starts_with("path_met"))
grep("AshleyDene", x = path_met_Iversen12_SD1)
path_met_Iversen12_SD2

tar_load(starts_with("lucerne_height"))
lucerne_height_AshleyDene_SD1


tar_load(starts_with("obs"))
obs_AshleyDene_SD1

tar_load(starts_with("BD"))
BD_AshleyDene_SD1

tar_read(magicDate)

tar_read(sowingDates)

tar_load(starts_with("met"))

met_AshleyDene_SD1


met_Iversen12_SD1
tar_load(LAI_Height)
tar_load(sowingDates)
sowingDates
tar_load(starts_with("CoverData"))
CoverData_AshleyDene_SD1
tar_load(data_SW)
data_SW
tar_load(value_vars)
tar_load(id_vars)
```
# SOIL PARAMS
```{r}
tar_load(starts_with("DUL_LL_range_arbitrary"))
DUL_LL_range_arbitrary_Iversen12_SD1
tar_load(starts_with("SW_sub"))
SW_sub_AshleyDene_SD1

# DT = data_SW[Experiment == "AshleyDene" & SowingDate == "SD1"]


SW_sub_Iversen12_SD1
SW_sub_Iversen12_SD2
deparse(substitute(SW_sub_Iversen12_SD2))
tar_load(starts_with("input_list"))

names(input_list_AshleyDene_SD1)


```
# Debug sw initials

```{r}
tar_load(starts_with("SW_initials"))
tar_load(starts_with("SW_sub"))
tar_load(starts_with("sowingDates"))
tar_load(starts_with("actual"))
tar_load(starts_with("id_vars"))
SW_initials_AshleyDene_SD1
SW_initials_AshleyDene_SD2
sowingDates
actualSD_AshleyDene_SD1
id_vars
initialSWC(SW_sub_AshleyDene_SD1, 
           sowingDates = actualSD_AshleyDene_SD1, id_vars)


```


# config file

```{r}
tar_load(template)
tar_load(params)
params
temp <- gsub("(?<=\\=)\\s.+$","",template, perl = TRUE)
input_list_AshleyDene_SD1$SW_initials_AshleyDene_SD1

temp
names(input_list_AshleyDene_SD1)
names(input_list_AshleyDene_SD1$DUL_LL_range_arbitrary_AshleyDene_SD1)

tar_load(params)
parameters <- params[!is.na(parameter)
       ][,.(parameter, lower, uppper, layer)
         ][, initials:= uppper/2][]

```

```{r}


temp_list <- vector("list", length = length(temp))
names(temp_list) <- temp
# for(i in seq_len(length(template))){
#   temp_list[[i]] <- template[i]
# }
tar_load(starts_with("SimName"))

# the code below was for construct the value list object 
## initial configuration
temp_list$`[Site].Name =` <- SimName_AshleyDene_SD1
temp_list$`[DataStore].ExcelInput.FileNames = ` <- obs_AshleyDene_SD1
temp_list$`[SlurpSowingRule].Script.SowingDate =` <- as.character(actualSD_AshleyDene_SD1$Clock.Today)
temp_list$`[Weather].FileName =` <-  path_met_AshleyDene_SD1
temp_list$`[SetCropVariables].Script.CoverFile =` <- CoverData_AshleyDene_SD1
temp_list$`[SetCropVariables].Script.MaximumHeight =` <- lucerne_height_AshleyDene_SD1
temp_list$`[Soil].Physical.BD =` <- paste(BD_AshleyDene_SD1$adjustedBD/1000, collapse = ",")
temp_list$`[Soil].InitialConditions.SW =` <- paste(SW_initials_AshleyDene_SD1$SW,
                                                   collapse = ",")
temp_list$`[Soil].Physical.DUL =` <- paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.DUL,
                                           collapse = ",")
temp_list$`[Soil].Physical.SlurpSoil.LL =`<- paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.LL,
                                           collapse = ",")


temp_list$`[Soil].Physical.SAT =`<- paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SAT,
                                           collapse = ",")
temp_list$`[Soil].Physical.AirDry =`<- paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.LL,
                                           collapse = ",")

temp_list$`[Soil].Physical.LL15 =`<- paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.LL,
                                           collapse = ",")
## parameters that need optimisation

temp_list$`[Soil].Physical.SlurpSoil.KL[1:22] =` <- parameters[parameter == "KL"]$initials
temp_list$`[SlurpSowingRule].Script.RFV =`<- parameters[parameter %like% "RFV"]$initials
temp_list$`[SlurpSowingRule].Script.KLReductionFactor =`<- parameters[parameter %like% "KLR"]$initials
temp_list$`[SlurpSowingRule].Script.MaxG =`<- parameters[parameter %like% "gsmax350"]$initials
temp_list$`[SlurpSowingRule].Script.R50 =`<- parameters[parameter %like% "R50"]$initials
temp_list$`[SlurpSowingRule].Script.SummerU =`<- parameters[parameter %like% "SummerU"]$initials
temp_list$`[SlurpSowingRule].Script.SummerCona =`<- parameters[parameter %like% "SummerCona"]$initials
temp_list$`[SlurpSowingRule].Script.WinterU =`<- parameters[parameter %like% "WinterU"]$initials
temp_list$`[SlurpSowingRule].Script.WinterCona =`<- parameters[parameter %like% "WinterCona"]$initials


## Could be messed up by the order
# value_list <- list(SimName_AshleyDene_SD1,
#                    obs_AshleyDene_SD1,
#                    as.character(actualSD_AshleyDene_SD1$Clock.Today),
#                    path_met_AshleyDene_SD1,
#                    CoverData_AshleyDene_SD1,
#                    lucerne_height_AshleyDene_SD1,
#                    paste(BD_AshleyDene_SD1$adjustedBD/1000, collapse = ","),
#                    paste(SW_initials_AshleyDene_SD1$SW, collapse = ","),
#                    paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.DUL, collapse = ","),
#                    parameters[parameter == "KL"]$initials,
#                    paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.LL, collapse = ","),
#                    paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SAT, collapse = ","),
#                    paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.LL, collapse = ","),
#                    paste(DUL_LL_range_arbitrary_AshleyDene_SD1$SW.LL, collapse = ","),
#                    parameters[parameter %like% "RFV"]$initials,
#                    parameters[parameter %like% "KLR"]$initials,
#                    parameters[parameter %like% "gsmax350"]$initials,
#                    parameters[parameter %like% "R50"]$initials,
#                    parameters[parameter %like% "SummerU"]$initials,
#                    parameters[parameter %like% "SummerCona"]$initials,
#                    parameters[parameter %like% "WinterU"]$initials,
#                    parameters[parameter %like% "WinterCona"]$initials)
# 
# if(length(temp_list) == length(value_list)){
#   for(i in seq_len(length(temp_list))){
#     temp_list[[i]] <- value_list[[i]]
#     }
# }

```
## Test the config file
```{r}
id <- "test"
path_config <- here(paste0("01Data/ProcessedData/ConfigurationFiles/","temp", id, ".txt"))
f = file(path_config, "w")
  for(i in seq_len(length(temp_list))){
    line = paste0(names(temp_list[i]) ," ", temp_list[[i]])
    cat(line, "\r",
        file = f, 
        append = TRUE)
  }
  # Close the file and clean it from memory 
  close(f)
  rm(f)
  gc()
  
  
  
id <- "test"
apsimx_sims_dir <- here("01Data/ProcessedData/apsimxFiles2021.04.29.22.29.31/")
apsimx_file <- here("01Data/ApsimxFiles/SingleSlurp.apsimx")
tar_load(path_apsimx)
  # Create a new name for the apsimx file 
  newname = paste0(apsimx_sims_dir, '/temp', id, ".apsimx")
 
  # Copy base apsimx file to its new name 
  system(paste("cp", apsimx_file, newname))
  
  # Modify the apsimx file 
  # system(paste(path_apsimx, "--edit", path_config, newname))
  

```
# get DEOPTIM?


```{r}
paravals <- c(0.25, 0.005,12,0.008,200,10,5,4,2)
# Edit fun
APSIMEditFun <- function( paravals, nodes = template,
                         initial_cond = 13L,
                         input_list = input_list_AshleyDene_SD1){
  no.ofPara <- length(paravals)
  id <- paste0(paravals, collapse = '_')
  
  temp_initial <- gsub("(?<=\\=)\\s.+$","",nodes, perl = TRUE)
  temp_ini_list <- vector("list", length = length(temp_initial))
  names(temp_ini_list) <- temp_initial
  ## initial configuration
  temp_ini_list$`[Site].Name =` <- input_list[[1]]
  temp_ini_list$`[DataStore].ExcelInput.FileNames = ` <- input_list[[2]]
  temp_ini_list$`[SlurpSowingRule].Script.SowingDate =` <- as.character(input_list[[3]]$Clock.Today)
  temp_ini_list$`[Weather].FileName =` <- input_list[[4]]
  temp_ini_list$`[SetCropVariables].Script.CoverFile =` <-  input_list[[5]]
  temp_ini_list$`[SetCropVariables].Script.MaximumHeight =` <-  input_list[[6]]
  temp_ini_list$`[Soil].Physical.BD =` <- paste( input_list[[7]]$adjustedBD/1000, collapse = ",")
  temp_ini_list$`[Soil].InitialConditions.SW =` <- paste( input_list[[8]]$SW,
                                                     collapse = ",")
  temp_ini_list$`[Soil].Physical.DUL =` <- paste( input_list[[9]]$SW.DUL,
                                             collapse = ",")
  temp_ini_list$`[Soil].Physical.SlurpSoil.LL =`<- paste(input_list[[9]]$SW.LL,
                                             collapse = ",")
  temp_ini_list$`[Soil].Physical.SAT =`<- paste(input_list[[9]]$SAT,
                                             collapse = ",")
  temp_ini_list$`[Soil].Physical.AirDry =`<- paste(input_list[[9]]$SW.LL,
                                             collapse = ",")
  temp_ini_list$`[Soil].Physical.LL15 =`<- paste(input_list[[9]]$SW.LL,
                                             collapse = ",")
  for(i in (initial_cond+1):length(nodes)){
    temp_ini_list[[i]] <- paravals[i-initial_cond]
  }
  path_config <- here("01Data/ProcessedData/ConfigurationFiles", 
                      paste0("temp", id, ".txt"))
  f<- file(path_config, "w")
  
  for(i in seq_len(length(nodes))){
    line <- paste0(names(temp_ini_list[i]) ," ", temp_ini_list[[i]])
    cat(line, "\r",
        file = f, 
        append = TRUE)
  }
  # Close the file and clean it from memory 
  close(f)
  rm(f)
  gc()
}
APSIMEditFun(paravals = paravals)
APSIMRun = function(par){
  # Create a new name for the apsimx file 
  id <- paste0(par, collapse = '_')
  path_config <- here("01Data/ProcessedData/ConfigurationFiles", 
                      paste0("temp", id, ".txt"))
  # Create a new name for the apsimx file 
  newname <- paste0(apsimx_sims_dir, '/temp', id, ".apsimx")
 
  # Copy base apsimx file to its new name 
  system(paste("cp", apsimx_file, newname))
  
  # Modify the apsimx file 
  system(paste(path_apsimx, "--edit", path_config, newname))
  
  # # Execute the new apsimx file 
  # system(paste(apsimx, newname, 
  #                "/NumberOfProcessors:8"))
    
}
APSIMRun(par = paravals)
# The cost
tar_load(magicDate)
cost.function <- function(par, obspara = "SWCmm", reset = magicDate){
  id <- paste0(par, collapse = '_')
  cat("Processing param combination: ",par, "\r\n")
  APSIMEditFun(par)
  APSIMRun(par)
  db <- RSQLite::dbConnect(RSQLite::SQLite(),
                           paste0(apsimx_sims_dir, '/temp', id,'.db'))
  

  PredictedObserved <- data.table::as.data.table(
    RSQLite::dbReadTable(db,"PredictedObserved"))
  PredictedObserved <- PredictedObserved[Clock.Today >= reset]
  # Generate multiple cost depends on user input of observation variables 
  no.ofobspara <- length(obspara)
  l <- vector("list", length = no.ofobspara)
  names(l) <- obspara
  for (i in seq_len(no.ofobspara)){
    pre_col <- paste0("Predicted.", obspara[i])
    obs_col <- paste0("Observed.", obspara[i])
    l[[i]] <- sum(na.omit(PredictedObserved[[pre_col]]- 
                          PredictedObserved[[obs_col]])^2)
  }

  totalCost = 0 
  totalCost = sum(unlist(l))

  RSQLite::dbDisconnect(db)
  
  rm(db)
  gc()
  
  system(paste("rm", paste0(apsimx_sims_dir, "/temp", id, "*")))
  
  return(totalCost)
}

cost.function(par)
```
# assemble the cost and DEoptim
```{r}
t1 = Sys.time()
#DEoptim
maxIt = 10
np = 3
lower = c(0.005,  0.0005, 10)
upper = c(0.11, 0.01, 35)
# The observaion value that will be used as the benchmark
obspara = "SWC"

opt.res =
  DEoptim::DEoptim(fn=cost.function, 
                   lower = lower,
                   upper = upper,
                   control=list(NP=np * 10, itermax=maxIt, parallelType=1,
                                storepopfrom = 1,
                                packages = c('RSQLite'),
                                parVar = c(
                                'slurpnodes',
                                'apsimx',
                                'apsimx_flag',
                                'apsimx_file',
                                'obspara',
                                'apsimx_sims_dir',
                                'apsimx_config',
                                'APSIMEditFun', 
                                'APSIMRun' ))
  )


save(opt.res, file =  file.path(apsimx_sims_dir,
                                paste0(Sys.Date(), 'opt.res', ".RData")))

fit.par = data.frame(estimates = opt.res$optim$bestmem, cost = opt.res$optim$bestval)

 
#output the statistical test
par = fit.par$estimates

write.csv(par, 'C:/Data/Master/03processed-data/opt.par.csv', row.names = F)
t2 = Sys.time()
t2-t1
```


# address issue 46

```{r}
input_list_AshleyDene_SD1$DUL_LL_range_arbitrary_AshleyDene_SD1 %>% 
  ggplot(aes(x = Depth))+
  geom_point(aes(y = SW.DUL , color = "DUL"))+
  geom_line(aes(y = SW.DUL, color = "DUL")) +
  geom_line(aes(y = SW.LL, color = "LL"))+
  geom_point(aes(y = SW.LL, color = "LL")) +
  scale_x_reverse() +
  coord_flip() +
  geom_ribbon(aes(ymin = SW.LL, ymax = SW.DUL), fill = "#1ca3ec") +
  facet_grid(  SowingDate ~ Experiment) +
  theme_water() +
  scale_color_manual(name = "", values = c("#0000FF", "#FF0000"))
```



```{r}
variables <- regmatches(temp, 
                        regexpr("(?=)\\.\\w{1,}\\s=$", temp, perl = TRUE)) %>% 
  gsub("\\W", "", .)
variables 




```



# Debug couldn't find objects

```{r}
tar_load("data_SW")
tar_load("value_vars")
tar_load("id_vars")
doDUL_LL_range(SW = tar_read(SW_mean_new))
filter_datemax(SW_mean = tar_read("SW_mean_new"), "max", id.vars = id_vars)
```
# Inspect ranges

```{r fig.height=10}
tar_load("DUL_LL_range")
tar_load("data_SW")
tar_load("value_vars")
tar_load("id_vars")
DUL_LL_range
tar_load("SW_mean_new")
SW_mean_new

data_SW
range_check <- function(DT,  layer, boundry = c("DUL","LL")){
  yval <-  paste0("SWmm.",layer, "..mean")
  cols <- c("Experiment", "Clock.Today", "SowingDate",yval)
  DT <- DT[,..cols]
  # yval <- paste0("`",layer,"`")
  P <- DT[,..cols] %>% 
    ggplot(aes_string("Clock.Today", yval)) + 
    geom_point() +
    facet_grid(SowingDate  ~ Experiment) 
  if(boundry =="LL"){
    dt_sub <- DT[order(SWmm.1..mean), .SD[1], by = .(Experiment, SowingDate)]
    P <- P + 
      geom_point(data = dt_sub , aes_string("Clock.Today", yval),  color ="red", size = 5)
  } else if (boundry == "DUL"){
    dt_sub <- DT[order(SWmm.1..mean, decreasing = TRUE), .SD[1], by = .(Experiment, SowingDate)]
    P <- P + 
      geom_point(data =dt_sub, aes_string("Clock.Today", yval),  color ="red", size = 5)
  } else{
    print("Don't know what to draw. DUL or LL")
  }
  return(P)
  
}
range_check(SW_mean_new, 1, boundry = "DUL")
range_check(SW_mean_new, 1, boundry = "LL")



```
It is not ideal to have a DUL from the end of the experiments. 
need to constrain the period 
**action** - modify the DUL and LL finder to lock the period. 

LL seems not the lowest since we constrian the period. 
maybe the end of June is good?
```{r fig.height=10}


range_check(SW_mean_new, 1, boundry = "LL")
```

```{r, fig.height=14, fig.width=9}
sdcols <- grep("sd", colnames(SW_mean_new), value = TRUE)
neededcols <- c(id_vars, sdcols)
DT_sd <- SW_mean_new[,..neededcols
                 ][, SWmm.1..sd := SWmm.1..sd /200
                   ][, (paste0("SWmm.", 2:22,"..sd")) := lapply(.SD, function(x) x/100),
                     .SDcols = paste0("SWmm.", 2:22,"..sd"),
                     by = id_vars]

tar_load(DUL_LL_range)


DUL_sd <- DT_sd %>% 
  melt.data.table(id.vars = id_vars, value.name = "SW.sd.DUL",
                  variable.name = "Depth",
                  variable.factor = FALSE)
DUL_sd[, Depth := as.integer(gsub("\\D", "", Depth))]
LL_sd <- DT_sd %>% 
  melt.data.table(id.vars = id_vars, value.name = "SW.sd.LL",
                  variable.name = "Depth",
                  variable.factor = FALSE)
LL_sd[, Depth := as.integer(gsub("\\D", "", Depth))]

DUL_LL_range <- DUL_sd[DUL_LL_range, on = c("Experiment", "SowingDate", "Depth"," Clock.Today == Clock.Today.DUL")] 
DUL_LL_range <- LL_sd[DUL_LL_range, on = c("Experiment", "SowingDate", "Depth"," Clock.Today == Clock.Today.LL")] 


DUL_LL_range[SowingDate %in% paste0("SD", 1:5)]%>% 
  ggplot(aes(x = Depth))+
  geom_point(aes(y = SW.DUL))+
  geom_line(aes(y = SW.DUL)) +
   geom_line(aes(y = SW.LL))+
  # geom_point()+
  scale_x_reverse() +
  coord_flip() +
  geom_point(aes(y = SW.LL)) +
  geom_errorbar(aes(ymin = SW.DUL - SW.sd.DUL, ymax = SW.DUL + SW.sd.DUL))+
  # geom_point(aes(y = Low.DUL), color = "red") +
  # geom_point(aes(y = High.DUL), color = "blue") +
  geom_errorbar(aes(ymin = SW.LL - SW.sd.LL, ymax = SW.LL + SW.sd.LL))+
  # geom_point(aes(y = Low.LL), color = "red") +
  # geom_point(aes(y = High.LL), color = "blue") +
  facet_grid(  SowingDate ~ Experiment) +
  theme_water() 
ggsave("Data/images/DUL_LL.png", width = 9, height = 12, dpi = 320)
```
# check met files and cumTT
```{r}
tar_load(starts_with("met"))
met_AshleyDene
met_Iversen12
tar_load("cumTT")
cumTT %>% 
  ggplot(aes(Clock.Today, AccumTT)) +
  geom_point() +
  facet_grid( Experiment ~ . ) +
  theme_water()

```
# Check observed LAI and SW
```{r}
tar_read(observed)

```
# Check template
```{r}
tar_read(template)
```
# Check CoverData
```{r}
tar_load(CoverData)
CoverData[ SowingDate == "SD2"] %>% 
   ggplot(aes(Clock.Today, AccumTT)) +
  geom_point() +
  facet_grid( Experiment ~ . ) +
  theme_water()
CoverData[ SowingDate == "SD2" & Experiment == "AshleyDene"] %>% 
   ggplot(aes(Clock.Today, LAI)) +
  geom_point() +
  geom_line() +
  facet_grid( Experiment ~ . ) +
  theme_water()

# BRING IN THE RAW VALUES 
sd2LAI <- read_excel("C:/Data/Master/Data/ProcessedData/CoverData/ObservedAshleyDeneSD2.xlsx")
sd2LAI %>% 
  ggplot(aes(Clock.Today, LAImod)) +
  geom_point() +
  geom_line() +
  facet_grid( Experiment ~ . ) +
  theme_water() +
  ggtitle("AshleyDene SD2")

```
## Debug for LAI interpolatation 

```{r}
tar_load(LAI_Height)
tar_load(sowingDates)
tar_load(cumTT)
LAI_Height
sowingDates
cumTT
interp_LAI(biomass = LAI_Height, sowingDates, cumTT)[]
# observation <- LAI_Height[Experiment == "AshleyDene" & SowingDate == "SD2"]


LAI_Height_SD <- merge.data.table(LAI_Height, sowingDates,
                                  by = c("Experiment", "Clock.Today" , "SowingDate"), 
                                    all= TRUE)[,':='(LAImod = ifelse(is.na(LAImod), 0, LAImod),
                                                     Height = ifelse(is.nan(Height), NA, Height))]
  
  LAI_wide <- dcast.data.table(LAI_Height_SD, 
                               Experiment + Clock.Today ~ SowingDate, 
                               value.var = "LAImod" )

  
  
  DT <- merge.data.table(cumTT, LAI_wide, by = c("Experiment", "Clock.Today"), 
                         all.x = TRUE)
  # DT[, SD2:= zoo::na.approx(SD2, na.rm =FALSE)]
  
  
  DT <- melt.data.table(data = DT, 
                        id.vars = c("Experiment", "Clock.Today", "AccumTT"), 
                        value.name = "LAI",
                        variable.name = "SowingDate", variable.factor = FALSE)
  
  DT <- DT[, LAI:= zoo::na.approx(LAI,  na.rm = FALSE) , by = .(Experiment, SowingDate) ]
  
  DT <- DT[, LAI:= zoo::na.approx(LAI, na.rm = FALSE) ]
  DT %>% 
    ggplot(aes(Clock.Today, LAI)) +
  geom_point() +
  geom_line() +
  facet_grid( Experiment ~ . ) +
  theme_water() +
  ggtitle("AshleyDene SD2")
  DT <- DT[, ':='(k = 0.94)
     ][Experiment == "AshleyDene" & Clock.Today %between% c( '2011-11-30','2012-03-01'),
       k:= 0.66][, LI := 1 - exp(-k * LAI) ]
  

```
# Check SW_INITIALS
```{r}
tar_load(SW_initials)
SW_initials[]
cbp1 <- c("#FF0000", "#00FF00", "#0000FF", "#fab80a","#8c06ff", 
          "#dceeff", "#c6deff", "#a7ccff", "#85a8e3","#6c9bd0")
p_initialSW <- SW_initials %>% 
   ggplot(aes(x = Depth, color = SowingDate))+
  geom_point(aes(y = SW))+
  geom_line(aes(y = SW)) +
  scale_x_reverse() +
  coord_flip() +
  facet_grid(  ~ Experiment ) +
  theme_water() +
  scale_color_manual(values = cbp1)
SW_initials


errorbar <- dcast.data.table(SW_initials[SowingDate%in%paste0("SD",1:5)],Experiment + SowingDate + Clock.Today + Depth ~ Stats, value.var = "SW")
errorbar[Depth == 1, se := sd/200/2
         ][Depth != 1, se:= sd/100/2]
p_initialSW <- p_initialSW + 
  geom_errorbar(data = errorbar,
                aes(ymin = mean - se, ymax = mean + se), color = "grey")
p_initialSW
ggsave("Data/images/initialSW.png",plot = p_initialSW, width = 7, height =6, dpi = 320)

```

# Check DUL AND LL 

```{r}
tar_load(DUL_LL_range_arbitrary)
tar_load(esti_DUL_LL)
DUL_shift <- esti_DUL_LL %>% 
  ggplot(aes(Depth)) +
  geom_point(aes(y = DUL, color = "DUL")) + 
  geom_smooth(aes(y = DUL, color = "DUL"), se = FALSE,) +
  geom_point(aes(y = SW.DUL, color = "POSTDUL")) + 
  geom_smooth(aes(y = SW.DUL, color = "POSTDUL"), se = FALSE) +
   geom_point(aes(y = DUL * 0.95, color = "arbitraryDUL")) + 
  geom_smooth(aes(y = DUL * 0.95, color = "arbitraryDUL"), se = FALSE) +
  coord_flip()+
  facet_wrap(Experiment ~ .)+
  scale_x_reverse(limits = c(23, 0), expand = c(0,0)) 
  
DUL_shift +
  theme_water()+
  scale_color_manual(values = c("DUL" = "#FF0000", "POSTDUL" = "#0000FF", 
                                "arbitraryDUL" = "#00FF00"))
```


.Simulations.Slurp
.Simulations.SlurpMorris

# Check BDs

```{r}
tar_load(BDs)
p_BD <- BDs %>% 
  ggplot(aes(x = Depth))+
  geom_point(aes(y = Low))+
  geom_line(aes(y = Low)) +
  geom_line(aes(y = High))+
  geom_point(aes(y = High)) +
  scale_x_reverse() +
  coord_flip() +
  facet_grid(  ~ Experiment , scales = "free_x") +
  theme_water()
ggsave("Data/images/p_BD.png",plot = p_BD, width = 7, height =6, dpi = 320)

```

# Check LAI_input 

```{r}
tar_load(LAI_input)
LAI_input[1:5]
tar_load(observed)
observed
```

# Check relativeSW
```{r}
tar_load(relativeSW)

relativeSW %>% 
  ggplot(aes(Clock.Today, relativeSW, color = SowingDate)) +
  geom_point() +
  geom_line()+
  scale_x_date(date_breaks = "8 weeks") +
  geom_smooth() + 
  facet_grid( Experiment ~.)

```


# Check winter_AD/I12
```{r}
tar_load(winter_AD)
tar_load(winter_I12)
winter_AD
winter_I12
tar_load(list_AD)
tar_read(list_I12)
list_AD$data[[1]]
```

# check DUL estimation 
```{r}
tar_load(esti_DUL_AD)

esti_DUL_AD$results[[1]]
esti_DUL_AD$esti[[1]]
esti_DUL_AD$data[[1]]
esti_DUL_AD[1,]
tar_load(DUL_LL_range)
DUL_LL_range

esti_DUL_AD[, unlist(results, recursive = FALSE), by = .(Experiment, SowingDate, Depth)]


rbindlist(esti_DUL_AD$results)
tar_load(esti_DUL_LL)
esti_DUL_LL
```



# Check parameter ranges 

```{r}
tar_load(params_ranges)
names(params_ranges)[1:2]
```

# Check morris model & sampled values 

```{r}

tar_read(MorrisModels_0008acad)
tar_load(MorrisModels_0008acad)

MorrisModels_0008acad$meta

tar_load(sampledvalues)
nrow(sampledvalues)
lapply(sampledvalues, function(x){length(unique(x))})

```

